<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RPM_360 v5.0 | Unionpel Pacheco</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@300;400;500;600;700;800;900&family=Barlow:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
<style>
:root {
  --up-blue:#0066B3;--up-dark:#004E8C;--up-light:#1A84D4;--up-sky:#00A3E0;--up-sky-light:#33BBF0;
  --ink:#060C14;--ink-2:#0A1220;--ink-3:#0F1C2E;--panel:#162238;--panel-2:#1A2A42;
  --border:rgba(0,102,179,0.15);--border-2:rgba(0,102,179,0.25);
  --lime:#4BDE80;--amber:#F5A623;--fire:#E8391A;--teal:#00C4A7;
  --text-1:#EEF4FF;--text-2:#8AABCC;--text-3:#4A6880;
  --glow-blue:0 0 30px rgba(0,102,179,0.35);--glow-sky:0 0 20px rgba(0,163,224,0.25);
  --font-d:'Barlow Condensed',sans-serif;--font-b:'Barlow',sans-serif;--font-m:'JetBrains Mono',monospace;
  --r:8px;--rl:14px;--sw:244px;--nh:58px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:15px}
body{font-family:var(--font-b);background:var(--ink);color:var(--text-1);min-height:100vh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:var(--ink-2)}
::-webkit-scrollbar-thumb{background:var(--up-dark);border-radius:99px}

/* AUTH */
#auth-screen{position:fixed;inset:0;z-index:1000;background:var(--ink);display:flex;align-items:center;justify-content:center}
.auth-bg{position:absolute;inset:0;overflow:hidden}
.auth-bg::before{content:'';position:absolute;top:-15%;left:50%;transform:translateX(-50%);width:900px;height:900px;background:radial-gradient(ellipse,rgba(0,102,179,.18) 0%,rgba(0,163,224,.08) 40%,transparent 70%);animation:pulsebg 5s ease-in-out infinite}
.auth-bg::after{content:'';position:absolute;bottom:-20%;right:-10%;width:600px;height:600px;background:radial-gradient(ellipse,rgba(0,78,140,.12) 0%,transparent 70%)}
.auth-bg-grid{position:absolute;inset:0;background-image:linear-gradient(rgba(0,102,179,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(0,102,179,.04) 1px,transparent 1px);background-size:44px 44px}
@keyframes pulsebg{0%,100%{opacity:.6;transform:translateX(-50%) scale(1)}50%{opacity:1;transform:translateX(-50%) scale(1.08)}}
.auth-box{position:relative;z-index:1;width:430px;background:var(--ink-3);border:1px solid var(--border-2);border-radius:var(--rl);padding:42px;box-shadow:0 50px 100px rgba(0,0,0,.7),var(--glow-blue);animation:slide-up .6s cubic-bezier(.16,1,.3,1)}
@keyframes slide-up{from{opacity:0;transform:translateY(32px)}to{opacity:1;transform:translateY(0)}}
.auth-logo{display:flex;align-items:center;gap:16px;margin-bottom:32px}
.auth-logo-icon{width:56px;height:56px;background:linear-gradient(135deg,var(--up-blue),var(--up-sky));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;box-shadow:var(--glow-blue)}
.auth-logo-text h1{font-family:var(--font-d);font-size:30px;font-weight:900;color:var(--text-1);letter-spacing:.06em}
.auth-logo-text h1 span{color:var(--up-sky)}
.auth-logo-text p{font-size:11px;color:var(--text-3);letter-spacing:.12em;text-transform:uppercase;margin-top:2px}
.auth-divider{height:1px;background:var(--border-2);margin-bottom:26px;position:relative}
.auth-divider::after{content:'ACCESO AL SISTEMA';position:absolute;top:-8px;left:50%;transform:translateX(-50%);background:var(--ink-3);padding:0 12px;font-size:9px;font-weight:800;letter-spacing:.2em;color:var(--text-3);font-family:var(--font-m)}
.auth-field{margin-bottom:14px}
.auth-field label{display:block;font-size:11px;color:var(--text-3);margin-bottom:6px;letter-spacing:.1em;text-transform:uppercase;font-weight:700}
.auth-field input,.auth-field select{width:100%;background:var(--ink-2);border:1px solid var(--border-2);border-radius:var(--r);padding:11px 14px;color:var(--text-1);font-family:var(--font-b);font-size:14px;outline:none;transition:all .2s;appearance:none}
.auth-field input:focus,.auth-field select:focus{border-color:var(--up-blue);box-shadow:0 0 0 3px rgba(0,102,179,.18)}
.auth-field select option{background:var(--ink-2)}
.auth-btn{width:100%;padding:13px;background:linear-gradient(135deg,var(--up-blue),var(--up-sky));border:none;border-radius:var(--r);color:#fff;font-family:var(--font-d);font-size:16px;font-weight:800;letter-spacing:.12em;text-transform:uppercase;cursor:pointer;transition:all .2s;box-shadow:var(--glow-blue);margin-top:8px}
.auth-btn:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 8px 30px rgba(0,102,179,.5)}
.auth-error{background:rgba(232,57,26,.12);border:1px solid rgba(232,57,26,.3);border-radius:var(--r);padding:10px 14px;font-size:13px;color:#FF7A5C;margin-bottom:14px;display:none}
.auth-hint{text-align:center;margin-top:20px;font-size:11px;color:var(--text-3)}
.auth-hint strong{color:var(--up-sky-light)}

/* TOPNAV */
#topnav{height:var(--nh);background:var(--ink-2);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:14px;flex-shrink:0;position:sticky;top:0;z-index:50}
.nav-logo{display:flex;align-items:center;gap:10px;cursor:pointer}
.nav-logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--up-blue),var(--up-sky));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;color:#fff;box-shadow:0 2px 12px rgba(0,102,179,.4)}
.nav-logo-text{font-family:var(--font-d);font-size:21px;font-weight:900;color:var(--text-1);letter-spacing:.07em}
.nav-logo-text span{color:var(--up-sky)}
.nav-version{font-family:var(--font-m);font-size:9px;color:var(--text-3);padding:2px 7px;border-radius:4px;background:rgba(0,102,179,.1);border:1px solid var(--border)}
.nav-badge{font-family:var(--font-d);font-size:10px;font-weight:800;letter-spacing:.15em;text-transform:uppercase;padding:2px 9px;border-radius:3px;background:rgba(0,102,179,.15);color:var(--up-sky-light);border:1px solid var(--border-2)}
.nav-status{display:flex;align-items:center;gap:7px;padding:4px 12px;border-radius:99px;background:rgba(75,222,128,.07);border:1px solid rgba(75,222,128,.2);font-size:11px;color:var(--lime);font-family:var(--font-m)}
.nav-status-dot{width:7px;height:7px;border-radius:50%;background:var(--lime);box-shadow:0 0 8px var(--lime);animation:blink 2s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.35}}
.nav-spacer{flex:1}
.nav-time-block{text-align:right}
.nav-time{font-family:var(--font-m);font-size:16px;font-weight:600;color:var(--text-1)}
.nav-date{font-size:11px;color:var(--text-3)}
.nav-icon-btn{width:34px;height:34px;border-radius:var(--r);background:transparent;border:1px solid var(--border);color:var(--text-2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .2s;position:relative}
.nav-icon-btn:hover{background:var(--panel);color:var(--text-1);border-color:var(--border-2)}
.nav-notif-dot{position:absolute;top:5px;right:5px;width:7px;height:7px;border-radius:50%;background:var(--fire);border:1px solid var(--ink-2);display:none}
.nav-user{display:flex;align-items:center;gap:9px;cursor:pointer;padding:4px 10px;border-radius:var(--r);border:1px solid var(--border);transition:all .2s}
.nav-user:hover{background:var(--panel);border-color:var(--border-2)}
.nav-avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--up-blue),var(--up-sky));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:#fff;font-family:var(--font-d)}
.nav-user-info p{font-size:13px;font-weight:700;color:var(--text-1);line-height:1.2}
.nav-user-info span{font-size:11px;color:var(--text-3)}

/* LAYOUT */
#main-layout{display:flex;flex:1;overflow:hidden;height:calc(100vh - var(--nh))}
#app{display:flex;flex-direction:column;height:100vh}

/* SIDEBAR */
#sidebar{width:var(--sw);flex-shrink:0;background:var(--ink-2);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;overflow-x:hidden}
.sb-sec{font-size:9px;font-weight:800;letter-spacing:.2em;text-transform:uppercase;color:var(--text-3);padding:18px 16px 6px}
.sb-item{display:flex;align-items:center;gap:10px;padding:8px 16px;font-size:13px;font-weight:500;color:var(--text-2);cursor:pointer;border-left:3px solid transparent;transition:all .15s;user-select:none}
.sb-item:hover{color:var(--text-1);background:rgba(0,102,179,.06)}
.sb-item.active{color:var(--text-1);background:rgba(0,102,179,.12);border-left-color:var(--up-blue)}
.sb-item .si{width:20px;text-align:center;font-size:12px;opacity:.7}
.sb-item.active .si{opacity:1;color:var(--up-sky)}
.sb-badge{margin-left:auto;font-size:10px;padding:1px 7px;background:rgba(0,102,179,.2);color:var(--up-sky-light);border-radius:3px;font-family:var(--font-m);border:1px solid rgba(0,163,224,.2)}
.sb-badge-red{background:rgba(232,57,26,.18);color:#FF7A5C;border:1px solid rgba(232,57,26,.25)}
.sb-bottom{margin-top:auto;padding:14px 16px;border-top:1px solid var(--border)}
.sys-card{background:linear-gradient(135deg,rgba(0,78,140,.3),rgba(0,102,179,.15));border:1px solid var(--border-2);border-radius:var(--r);padding:12px}
.sys-row{display:flex;justify-content:space-between;align-items:center;font-size:11px;padding:2px 0}
.sys-row span:first-child{color:var(--text-3)}
.sys-ok{color:var(--lime);font-family:var(--font-m)}
.sys-warn{color:var(--amber);font-family:var(--font-m)}

/* CONTENT */
#content{flex:1;overflow-y:auto;background:var(--ink);padding:26px}
.module{animation:modin .3s cubic-bezier(.16,1,.3,1)}
@keyframes modin{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* PAGE HEADER */
.ph{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px}
.pt{font-family:var(--font-d);font-size:30px;font-weight:900;color:var(--text-1);letter-spacing:.04em}
.pt span{color:var(--up-sky)}
.ps{font-size:13px;color:var(--text-3);margin-top:2px}
.pa{display:flex;gap:8px;align-items:center}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:7px;padding:8px 16px;border-radius:var(--r);font-family:var(--font-b);font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .15s;white-space:nowrap;text-decoration:none}
.btn-primary{background:linear-gradient(135deg,var(--up-blue),var(--up-sky));color:#fff;box-shadow:0 2px 10px rgba(0,102,179,.35)}
.btn-primary:hover{filter:brightness(1.12);transform:translateY(-1px);box-shadow:0 5px 18px rgba(0,102,179,.45)}
.btn-secondary{background:var(--panel);color:var(--text-1);border:1px solid var(--border-2)}
.btn-secondary:hover{background:var(--panel-2)}
.btn-ghost{background:transparent;color:var(--text-2);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--panel);color:var(--text-1)}
.btn-danger{background:rgba(232,57,26,.15);color:#FF7A5C;border:1px solid rgba(232,57,26,.25)}
.btn-danger:hover{background:rgba(232,57,26,.25)}
.btn-green{background:rgba(75,222,128,.12);color:var(--lime);border:1px solid rgba(75,222,128,.2)}
.btn-green:hover{background:rgba(75,222,128,.2)}
.btn-sm{padding:6px 13px;font-size:12px}
.btn-xs{padding:3px 10px;font-size:11px}

/* CARDS */
.card{background:var(--ink-3);border:1px solid var(--border);border-radius:var(--rl);padding:20px}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.card-title{font-family:var(--font-d);font-size:16px;font-weight:800;color:var(--text-1);letter-spacing:.04em}

/* KPI CARDS */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:20px}
.kpi-card{background:var(--ink-3);border:1px solid var(--border);border-radius:var(--rl);padding:18px 20px;position:relative;overflow:hidden;transition:transform .2s,box-shadow .2s}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.kpi-blue::before{background:linear-gradient(90deg,var(--up-blue),var(--up-sky))}
.kpi-sky::before{background:linear-gradient(90deg,var(--up-sky),var(--up-sky-light))}
.kpi-lime::before{background:linear-gradient(90deg,var(--lime),#9ee080)}
.kpi-amber::before{background:linear-gradient(90deg,var(--amber),#fcd06a)}
.kpi-fire::before{background:linear-gradient(90deg,#E8391A,#F56C00)}
.kpi-teal::before{background:linear-gradient(90deg,var(--teal),#4de8d2)}
.kpi-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.4),var(--glow-sky)}
.kpi-label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.12em;color:var(--text-3);margin-bottom:8px}
.kpi-value{font-family:var(--font-d);font-size:36px;font-weight:900;color:var(--text-1);line-height:1}
.kpi-sub{font-size:12px;color:var(--text-3);margin-top:7px}
.kpi-icon{position:absolute;right:16px;top:50%;transform:translateY(-50%);font-size:34px;opacity:.06}
.kpi-up{color:var(--lime)}.kpi-down{color:#FF7A5C}

/* GRIDS */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}

/* TABLES */
.tbl{overflow-x:auto}
table.dt{width:100%;border-collapse:collapse;font-size:13px}
table.dt th{text-align:left;padding:10px 14px;font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.12em;color:var(--text-3);background:var(--ink-2);border-bottom:1px solid var(--border)}
table.dt td{padding:10px 14px;color:var(--text-2);border-bottom:1px solid rgba(0,102,179,.06)}
table.dt tr:hover td{background:rgba(0,102,179,.04)}
table.dt tr:last-child td{border-bottom:none}
.tdm{font-family:var(--font-m);font-size:12px}.tdb{color:var(--text-1);font-weight:600}

/* BADGES */
.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;letter-spacing:.05em;font-family:var(--font-m)}
.b-blue{background:rgba(0,102,179,.2);color:var(--up-sky-light);border:1px solid rgba(0,163,224,.2)}
.b-green{background:rgba(75,222,128,.12);color:var(--lime)}
.b-amber{background:rgba(245,166,35,.15);color:var(--amber)}
.b-fire{background:rgba(232,57,26,.15);color:#FF7A5C}
.b-teal{background:rgba(0,196,167,.15);color:var(--teal)}
.b-gray{background:rgba(255,255,255,.06);color:var(--text-3)}
.b-dot::before{content:'';width:5px;height:5px;border-radius:50%;background:currentColor;display:inline-block}

/* PROGRESS */
.prog{height:4px;background:var(--panel);border-radius:99px;overflow:hidden}
.prog-fill{height:100%;border-radius:99px;transition:width .8s}
.prog-blue{background:linear-gradient(90deg,var(--up-blue),var(--up-sky))}
.prog-lime{background:linear-gradient(90deg,var(--lime),#9ee080)}
.prog-amber{background:linear-gradient(90deg,var(--amber),#fcd06a)}
.prog-fire{background:linear-gradient(90deg,#E8391A,#F56C00)}

/* FORMS */
.fg{margin-bottom:14px}
.fl{display:block;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:var(--text-3);margin-bottom:6px}
.fi,.fs,.fta{width:100%;background:var(--ink-2);border:1px solid var(--border-2);border-radius:var(--r);padding:9px 13px;color:var(--text-1);font-family:var(--font-b);font-size:14px;outline:none;transition:all .2s;appearance:none}
.fi:focus,.fs:focus,.fta:focus{border-color:var(--up-blue);box-shadow:0 0 0 3px rgba(0,102,179,.15)}
.fs option{background:var(--ink-2)}
.fta{resize:vertical;min-height:80px}
.fg-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fg-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}

/* MODAL */
.modal-ov{position:fixed;inset:0;z-index:200;background:rgba(6,12,20,.88);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;padding:20px}
.modal-ov.open{display:flex;animation:fadein .2s}
@keyframes fadein{from{opacity:0}to{opacity:1}}
.modal-box{background:var(--ink-3);border:1px solid var(--border-2);border-top:2px solid var(--up-blue);border-radius:var(--rl);padding:28px;width:100%;max-width:680px;max-height:90vh;overflow-y:auto;animation:modalpop .3s cubic-bezier(.16,1,.3,1);box-shadow:0 40px 80px rgba(0,0,0,.7),var(--glow-blue)}
.modal-box.mlg{max-width:960px}
@keyframes modalpop{from{opacity:0;transform:scale(.94) translateY(18px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
.modal-title{font-family:var(--font-d);font-size:22px;font-weight:900;color:var(--text-1)}
.modal-close{width:30px;height:30px;border-radius:6px;background:var(--panel);border:1px solid var(--border);color:var(--text-3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .15s}
.modal-close:hover{background:var(--panel-2);color:var(--text-1)}
.modal-footer{display:flex;justify-content:flex-end;gap:8px;margin-top:24px;padding-top:16px;border-top:1px solid var(--border)}

/* CHECKLIST */
.cl-item{display:flex;align-items:center;justify-content:space-between;padding:9px 12px;border-radius:8px;margin-bottom:4px;border:1px solid var(--border);transition:background .15s}
.cl-item:hover{background:rgba(0,102,179,.05)}
.cl-label{font-size:12.5px;color:var(--text-2);flex:1;padding-right:12px}
.cl-ctrls{display:flex;align-items:center;gap:8px;flex-shrink:0}
.rg{display:flex;gap:10px}
.ro{display:flex;align-items:center;gap:4px;cursor:pointer;font-size:12px;font-weight:700}
.ro input[type=radio]{accent-color:var(--up-blue);width:14px;height:14px}
.ro.si{color:var(--lime)}.ro.no{color:#FF7A5C}
.cl-obs{background:var(--ink-2);border:1px solid var(--border);border-radius:6px;padding:5px 9px;color:var(--text-1);font-size:11px;font-family:var(--font-b);outline:none;width:150px;transition:border .2s}
.cl-obs:focus{border-color:var(--up-blue)}
.tab-bar{display:flex;overflow-x:auto;border-bottom:1px solid var(--border);background:var(--ink-2)}
.tab-btn{padding:10px 15px;font-size:11px;font-weight:700;color:var(--text-3);cursor:pointer;border:none;background:transparent;border-bottom:2px solid transparent;transition:all .15s;white-space:nowrap;font-family:var(--font-b);letter-spacing:.02em}
.tab-btn:hover{color:var(--text-2);background:rgba(0,102,179,.05)}
.tab-btn.active{color:var(--up-sky);border-bottom-color:var(--up-blue)}
.tab-panel{display:none;padding:14px}
.tab-panel.active{display:block}

/* KANBAN */
.kanban-board{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.k-col{background:var(--ink-2);border:1px solid var(--border);border-radius:var(--rl);padding:14px;min-height:360px}
.k-col-h{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.k-col-t{font-family:var(--font-d);font-size:14px;font-weight:900;text-transform:uppercase;letter-spacing:.1em}
.k-card{background:var(--ink-3);border:1px solid var(--border);border-radius:var(--r);padding:12px;margin-bottom:8px;cursor:pointer;transition:all .2s;border-left:3px solid transparent}
.k-card:hover{border-color:var(--up-blue);transform:translateX(2px);box-shadow:0 4px 14px rgba(0,0,0,.4)}
.k-card.pc{border-left-color:#E8391A}.k-card.ph{border-left-color:var(--amber)}.k-card.pm{border-left-color:var(--up-blue)}.k-card.pl{border-left-color:var(--text-3)}
.k-id{font-family:var(--font-m);font-size:10px;color:var(--text-3);margin-bottom:4px}
.k-tit{font-size:13px;font-weight:600;color:var(--text-1);margin-bottom:8px}
.k-meta{display:flex;align-items:center;gap:5px;flex-wrap:wrap}

/* NOTIF PANEL */
#notif-panel{position:fixed;top:calc(var(--nh) + 8px);right:16px;width:340px;z-index:100;background:var(--ink-3);border:1px solid var(--border-2);border-top:2px solid var(--up-blue);border-radius:var(--rl);box-shadow:0 20px 50px rgba(0,0,0,.6),var(--glow-blue);display:none}
#notif-panel.open{display:block;animation:slidedn .2s ease}
@keyframes slidedn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.notif-hdr{padding:13px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.notif-title{font-family:var(--font-d);font-size:14px;font-weight:800;color:var(--text-1)}
.notif-item{padding:11px 16px;border-bottom:1px solid rgba(0,102,179,.06);display:flex;gap:10px}
.notif-item:last-child{border-bottom:none}
.notif-dot{width:7px;height:7px;border-radius:50%;margin-top:5px;flex-shrink:0}
.notif-text{font-size:12px;color:var(--text-2);line-height:1.5}
.notif-time{font-size:10px;color:var(--text-3);margin-top:2px;font-family:var(--font-m)}

/* USER MENU */
#user-menu{position:fixed;top:calc(var(--nh) + 8px);right:16px;width:210px;z-index:100;background:var(--ink-3);border:1px solid var(--border-2);border-top:2px solid var(--up-blue);border-radius:var(--rl);box-shadow:0 20px 50px rgba(0,0,0,.6);display:none;overflow:hidden}
#user-menu.open{display:block;animation:slidedn .2s ease}
.um-hdr{padding:14px 16px;border-bottom:1px solid var(--border);background:var(--ink-2)}
.um-name{font-size:14px;font-weight:700;color:var(--text-1)}
.um-role{font-size:11px;color:var(--text-3);margin-top:1px}
.um-item{padding:10px 16px;font-size:13px;color:var(--text-2);cursor:pointer;display:flex;align-items:center;gap:10px;transition:all .15s}
.um-item:hover{background:rgba(0,102,179,.08);color:var(--text-1)}
.um-item.danger{color:#FF7A5C}
.um-item.danger:hover{background:rgba(232,57,26,.08)}

/* BOT */
#bot-container{position:fixed;bottom:22px;right:22px;z-index:150}
#bot-btn{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--up-blue),var(--up-sky));border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;box-shadow:0 4px 20px rgba(0,102,179,.6),0 0 0 3px rgba(0,163,224,.18);transition:all .2s;position:relative}
#bot-btn:hover{transform:scale(1.08);box-shadow:0 6px 28px rgba(0,102,179,.75)}
#bot-btn::after{content:'IA';position:absolute;top:-4px;right:-4px;background:#E8391A;color:#fff;font-size:8px;font-weight:900;font-family:var(--font-m);padding:1px 4px;border-radius:4px;border:1px solid var(--ink)}
#bot-chat{position:absolute;bottom:66px;right:0;width:420px;height:600px;background:var(--ink-3);border:1px solid var(--border-2);border-top:2px solid var(--up-blue);border-radius:var(--rl);display:none;flex-direction:column;box-shadow:0 24px 64px rgba(0,0,0,.8),var(--glow-blue);overflow:hidden}
#bot-chat.open{display:flex;animation:slide-up .3s cubic-bezier(.16,1,.3,1)}
.bot-header{padding:12px 16px;background:linear-gradient(135deg,var(--ink-2),var(--panel));border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
.bot-avatar-wrap{position:relative;flex-shrink:0}
.bot-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--up-blue),var(--up-sky));display:flex;align-items:center;justify-content:center;font-size:16px;color:#fff;box-shadow:0 2px 10px rgba(0,102,179,.5);border:2px solid rgba(0,163,224,.35)}
.bot-avatar-badge{position:absolute;bottom:-1px;right:-1px;width:14px;height:14px;border-radius:50%;background:var(--lime);border:2px solid var(--ink-2);display:flex;align-items:center;justify-content:center;font-size:7px;color:var(--ink);font-weight:900}
.bot-info{flex:1}
.bot-name{font-family:var(--font-d);font-size:15px;font-weight:900;color:var(--text-1);letter-spacing:.03em}
.bot-title{font-size:10px;color:var(--up-sky-light);font-family:var(--font-m);letter-spacing:.06em}
.bot-status-row{display:flex;align-items:center;gap:8px;margin-top:2px}
.bot-status-dot{width:6px;height:6px;border-radius:50%;background:var(--lime);box-shadow:0 0 6px var(--lime);animation:blink 2s infinite;flex-shrink:0}
.bot-status-txt{font-size:10px;color:var(--lime)}
.bot-learn-badge{font-size:9px;padding:1px 6px;background:rgba(245,166,35,.15);border:1px solid rgba(245,166,35,.3);border-radius:4px;color:var(--amber);font-family:var(--font-m)}
.bot-actions{display:flex;gap:6px}
.bot-act-btn{width:26px;height:26px;border-radius:6px;background:transparent;border:1px solid var(--border);color:var(--text-3);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;transition:all .15s}
.bot-act-btn:hover{background:var(--panel-2);color:var(--text-1)}
.bot-tabs{display:flex;border-bottom:1px solid var(--border);background:var(--ink-2)}
.bot-tab{flex:1;padding:8px 12px;font-size:10px;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:var(--text-3);cursor:pointer;border:none;background:transparent;border-bottom:2px solid transparent;transition:all .15s;font-family:var(--font-b)}
.bot-tab.active{color:var(--up-sky);border-bottom-color:var(--up-blue);background:rgba(0,102,179,.05)}
.bot-msgs{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
.bot-msg{max-width:90%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.6}
.from-bot{background:var(--panel);color:var(--text-2);border-bottom-left-radius:3px;align-self:flex-start;border:1px solid var(--border)}
.from-bot strong{color:var(--text-1)}
.from-bot code{background:var(--ink-2);padding:1px 5px;border-radius:4px;font-family:var(--font-m);font-size:11px;color:var(--up-sky-light)}
.from-bot .bot-tip{background:rgba(0,163,224,.06);border-left:2px solid var(--up-sky);padding:6px 10px;border-radius:0 6px 6px 0;margin-top:8px;font-size:12px}
.from-bot .bot-warn{background:rgba(245,166,35,.07);border-left:2px solid var(--amber);padding:6px 10px;border-radius:0 6px 6px 0;margin-top:8px;font-size:12px;color:var(--amber)}
.from-bot .bot-ref{background:rgba(75,222,128,.05);border-left:2px solid var(--lime);padding:6px 10px;border-radius:0 6px 6px 0;margin-top:8px;font-size:12px;color:var(--lime)}
.from-user{background:rgba(0,102,179,.2);color:var(--text-1);border-bottom-right-radius:3px;align-self:flex-end;border:1px solid rgba(0,102,179,.3)}
.bot-typing{display:flex;align-items:center;gap:4px;padding:10px 14px;background:var(--panel);border-radius:12px;border-bottom-left-radius:3px;align-self:flex-start;width:60px;border:1px solid var(--border)}
.bot-typing span{width:6px;height:6px;border-radius:50%;background:var(--up-sky);display:block;animation:typing 1.4s infinite}
.bot-typing span:nth-child(2){animation-delay:.2s}.bot-typing span:nth-child(3){animation-delay:.4s}
@keyframes typing{0%,60%,100%{transform:translateY(0);opacity:.5}30%{transform:translateY(-6px);opacity:1}}
.bot-quick-row{padding:8px 14px;border-top:1px solid var(--border);display:flex;gap:5px;overflow-x:auto}
.bot-quick{padding:5px 10px;background:var(--panel);border:1px solid var(--border-2);border-radius:16px;font-size:11px;color:var(--up-sky-light);cursor:pointer;white-space:nowrap;transition:all .15s;font-family:var(--font-b);font-weight:600}
.bot-quick:hover{background:rgba(0,102,179,.15);border-color:var(--up-blue)}
.bot-input-row{padding:10px 13px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:flex-end;background:var(--ink-2)}
.bot-input{flex:1;background:var(--ink-3);border:1px solid var(--border-2);border-radius:16px;padding:8px 14px;color:var(--text-1);font-size:13px;outline:none;resize:none;max-height:80px;font-family:var(--font-b);line-height:1.5}
.bot-input:focus{border-color:var(--up-blue);box-shadow:0 0 0 2px rgba(0,102,179,.15)}
.bot-send{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--up-blue),var(--up-sky));border:none;color:#fff;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s}
.bot-send:hover{filter:brightness(1.15);transform:scale(1.05)}
.bot-send:disabled{opacity:.4;cursor:not-allowed;transform:none}
/* Knowledge panel */
.bot-panel-know{flex:1;overflow-y:auto;padding:14px;display:none}
.bot-panel-know.active{display:block}
.know-cat{margin-bottom:16px}
.know-cat-t{font-size:10px;font-weight:900;text-transform:uppercase;letter-spacing:.15em;color:var(--up-sky);padding:4px 8px;background:rgba(0,102,179,.08);border-radius:4px;margin-bottom:8px;display:inline-block}
.know-item{padding:7px 10px;border:1px solid var(--border);border-radius:6px;margin-bottom:6px;cursor:pointer;transition:all .15s}
.know-item:hover{background:rgba(0,102,179,.06);border-color:var(--border-2)}
.know-item-t{font-size:12px;font-weight:600;color:var(--text-1)}
.know-item-s{font-size:11px;color:var(--text-3);margin-top:2px}

/* PERSONAL GRID */
.per-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:12px}
.per-card{background:var(--ink-3);border:1px solid var(--border);border-radius:var(--rl);padding:16px 12px;text-align:center;transition:all .2s}
.per-card:hover{border-color:var(--up-blue);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.4),var(--glow-sky)}
.per-av{width:48px;height:48px;border-radius:50%;margin:0 auto 10px;background:linear-gradient(135deg,var(--up-dark),var(--up-sky));display:flex;align-items:center;justify-content:center;font-family:var(--font-d);font-size:18px;font-weight:800;color:#fff;box-shadow:0 4px 12px rgba(0,102,179,.35)}
.per-name{font-size:12.5px;font-weight:700;color:var(--text-1);margin-bottom:3px}
.per-cargo{font-size:11px;color:var(--text-3);line-height:1.4}

/* MISC */
.alert{padding:12px 16px;border-radius:var(--r);border-left:3px solid;margin-bottom:16px;font-size:13px}
.alert-info{background:rgba(0,102,179,.08);border-color:var(--up-blue);color:var(--text-2)}
.alert-warn{background:rgba(245,166,35,.08);border-color:var(--amber);color:var(--text-2)}
.alert-ok{background:rgba(75,222,128,.08);border-color:var(--lime);color:var(--text-2)}
.tag{display:inline-block;padding:2px 8px;background:rgba(0,102,179,.1);border:1px solid var(--border);border-radius:4px;font-size:11px;color:var(--text-3)}
.prog-bar{height:4px;background:var(--panel);border-radius:99px;overflow:hidden;margin-top:10px}
.prog-bar-fill{height:100%;border-radius:99px}
.drop-zone{border:2px dashed var(--border-2);border-radius:var(--rl);padding:30px;text-align:center;cursor:pointer;transition:all .2s;background:rgba(0,102,179,.02)}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--up-blue);background:rgba(0,102,179,.07)}
.dz-icon{font-size:32px;color:var(--up-sky);margin-bottom:10px;opacity:.6}
.chart-wrap canvas{max-height:280px}

@media(max-width:880px){
  #sidebar{display:none}
  .grid-2,.grid-3,.grid-4{grid-template-columns:1fr}
  .kanban-board{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen">
  <div class="auth-bg"><div class="auth-bg-grid"></div></div>
  <div class="auth-box">
    <div class="auth-logo">
      <div class="auth-logo-icon"><i class="fas fa-industry"></i></div>
      <div class="auth-logo-text">
        <h1>RPM<span>_360</span></h1>
        <p>Unionpel Pacheco · Sistema Industrial</p>
      </div>
    </div>
    <div class="auth-divider"></div>
    <div class="auth-error" id="auth-error">Usuario o contraseña incorrectos</div>
    <div class="auth-field"><label>Usuario</label><input type="text" id="login-user" placeholder="Ingrese su usuario" autocomplete="username"></div>
    <div class="auth-field"><label>Contraseña</label><input type="password" id="login-pass" placeholder="••••••••••" autocomplete="current-password"></div>
    <div class="auth-field"><label>Área</label>
      <select id="login-area">
        <option>Producción</option><option>Mantenimiento</option><option>Gerencia</option><option>Expedición</option><option>Seguridad</option>
      </select>
    </div>
    <button class="auth-btn" onclick="doLogin()"><i class="fas fa-sign-in-alt"></i> &nbsp;INGRESAR AL SISTEMA</button>
    <div class="auth-hint">Demo: <strong>admin</strong> / <strong>Unionpel 2026</strong> &nbsp;|&nbsp; también: <strong>amendolara</strong>, <strong>cassal</strong>, <strong>ramaglia</strong></div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <nav id="topnav">
    <div class="nav-logo" onclick="navigate('dashboard')">
      <div class="nav-logo-icon"><i class="fas fa-industry"></i></div>
      <span class="nav-logo-text">RPM<span>_360</span></span>
    </div>
    <span class="nav-version">v5.0</span>
    <span class="nav-badge">Industrial OS</span>
    <div class="nav-status"><div class="nav-status-dot"></div>SISTEMA ONLINE</div>
    <div class="nav-spacer"></div>
    <div class="nav-time-block">
      <div class="nav-time" id="nav-clock">--:--</div>
      <div class="nav-date" id="nav-date">--/--/----</div>
    </div>
    <button class="nav-icon-btn" onclick="toggleNotif()" title="Notificaciones">
      <i class="fas fa-bell"></i><span class="nav-notif-dot" id="notif-dot"></span>
    </button>
    <div class="nav-user" onclick="toggleUM()">
      <div class="nav-avatar" id="nav-av">--</div>
      <div class="nav-user-info"><p id="nav-uname">-</p><span id="nav-urole">-</span></div>
      <i class="fas fa-chevron-down" style="font-size:10px;color:var(--text-3)"></i>
    </div>
  </nav>

  <div id="notif-panel">
    <div class="notif-hdr"><span class="notif-title">Notificaciones</span><button class="btn btn-xs btn-ghost" onclick="clearNotifs()">Limpiar</button></div>
    <div id="notif-list"></div>
  </div>

  <div id="user-menu">
    <div class="um-hdr"><div class="um-name" id="um-name">-</div><div class="um-role" id="um-role">-</div></div>
    <div class="um-item" onclick="navigate('configuracion')"><i class="fas fa-cog"></i> Configuración</div>
    <div class="um-item danger" onclick="doLogout()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</div>
  </div>

  <div id="main-layout">
    <nav id="sidebar">
      <div class="sb-sec">Principal</div>
      <div class="sb-item active" data-mod="dashboard" onclick="navigate('dashboard')"><span class="si"><i class="fas fa-chart-line"></i></span> Dashboard 360°</div>
      <div class="sb-item" data-mod="turno" onclick="navigate('turno')"><span class="si"><i class="fas fa-clipboard-check"></i></span> Registro de Turno <span class="sb-badge">CORE</span></div>
      <div class="sb-sec">Gestión</div>
      <div class="sb-item" data-mod="historial" onclick="navigate('historial')"><span class="si"><i class="fas fa-history"></i></span> Historial Turnos</div>
      <div class="sb-item" data-mod="ots" onclick="navigate('ots')"><span class="si"><i class="fas fa-tools"></i></span> Órdenes de Trabajo <span class="sb-badge sb-badge-red" id="sb-ot-c">0</span></div>
      <div class="sb-item" data-mod="paradas" onclick="navigate('paradas')"><span class="si"><i class="fas fa-stopwatch"></i></span> Paradas de Planta</div>
      <div class="sb-sec">Análisis</div>
      <div class="sb-item" data-mod="energia" onclick="navigate('energia')"><span class="si"><i class="fas fa-bolt"></i></span> Energía & Utilities</div>
      <div class="sb-item" data-mod="proceso" onclick="navigate('proceso')"><span class="si"><i class="fas fa-scroll"></i></span> Proceso Papelero</div>
      <div class="sb-item" data-mod="reportes" onclick="navigate('reportes')"><span class="si"><i class="fas fa-file-chart-column"></i></span> Reportes</div>
      <div class="sb-sec">Administración</div>
      <div class="sb-item" data-mod="personal" onclick="navigate('personal')"><span class="si"><i class="fas fa-users"></i></span> Personal</div>
      <div class="sb-item" data-mod="configuracion" onclick="navigate('configuracion')"><span class="si"><i class="fas fa-sliders-h"></i></span> Configuración</div>
      <div class="sb-bottom">
        <div style="font-size:9px;color:var(--text-3);text-transform:uppercase;letter-spacing:.15em;font-weight:800;margin-bottom:8px">Estado Sistema</div>
        <div class="sys-card">
          <div class="sys-row"><span>DB Local</span><span class="sys-ok">OK</span></div>
          <div class="sys-row"><span>Registros</span><span class="sys-ok" id="sys-cnt">0</span></div>
          <div class="sys-row"><span>Versión</span><span class="sys-warn">v5.0 · 2026</span></div>
        </div>
        <button onclick="doLogout()" style="width:100%;margin-top:10px;display:flex;align-items:center;gap:8px;padding:8px 12px;background:transparent;border:1px solid var(--border);border-radius:var(--r);color:var(--text-3);cursor:pointer;font-size:12px;font-family:var(--font-b);transition:all .15s" onmouseover="this.style.color='#FF7A5C';this.style.borderColor='rgba(232,57,26,.3)'" onmouseout="this.style.color='var(--text-3)';this.style.borderColor='var(--border)'"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
      </div>
    </nav>
    <main id="content"></main>
  </div>
</div>

<div id="bot-container" style="display:none">
  <div id="bot-chat">
    <div class="bot-header">
      <div class="bot-avatar-wrap">
        <div class="bot-avatar"><i class="fas fa-robot"></i></div>
        <div class="bot-avatar-badge">&#9889;</div>
      </div>
      <div class="bot-info">
        <div class="bot-name">ARIA</div>
        <div class="bot-title">ING. SISTEMAS &middot; ING. ELECTROMEC&Aacute;NICO</div>
        <div class="bot-status-row">
          <div class="bot-status-dot"></div>
          <span class="bot-status-txt">IA activa</span>
          <span class="bot-learn-badge" id="bot-learn-lbl">&#128218; 0 aprendizajes</span>
        </div>
      </div>
      <div class="bot-actions">
        <button class="bot-act-btn" onclick="botClearHistory()" title="Limpiar chat"><i class="fas fa-broom"></i></button>
        <button class="bot-act-btn" onclick="toggleBot()" title="Cerrar"><i class="fas fa-times"></i></button>
      </div>
    </div>
    <div class="bot-tabs">
      <button class="bot-tab active" onclick="switchBotTab('chat',this)">&#128172; Chat</button>
      <button class="bot-tab" onclick="switchBotTab('know',this)">&#129504; Conocimiento</button>
      <button class="bot-tab" onclick="switchBotTab('tech',this)">&#9881; T&eacute;cnico</button>
    </div>
    <div class="bot-msgs" id="bot-msgs"></div>
    <div class="bot-panel-know" id="bot-panel-know">
      <div style="font-size:11px;color:var(--text-3);margin-bottom:10px">Conocimiento aprendido &middot; Click para consultar</div>
      <div id="know-list"></div>
    </div>
    <div class="bot-panel-know" id="bot-panel-tech">
      <div class="know-cat">
        <div class="know-cat-t">&#9889; Electricidad</div>
        <div class="know-item" onclick="askTech('Diagn&oacute;stico fallas motores el&eacute;ctricos CC/AC')"><div class="know-item-t">Diagn&oacute;stico fallas motores el&eacute;ctricos CC/AC</div><div class="know-item-s">Consultar procedimiento t&eacute;cnico &rarr;</div></div>
        <div class="know-item" onclick="askTech('Interpretaci&oacute;n de alarmas en variadores de frecuencia')"><div class="know-item-t">Interpretaci&oacute;n de alarmas en variadores de frecuencia</div><div class="know-item-s">Consultar procedimiento t&eacute;cnico &rarr;</div></div>
        <div class="know-item" onclick="askTech('Protecci&oacute;n diferencial y magnetot&eacute;rmica en plantas industriales')"><div class="know-item-t">Protecci&oacute;n diferencial y magnetot&eacute;rmica</div><div class="know-item-s">Consultar procedimiento t&eacute;cnico &rarr;</div></div>
        <div class="know-item" onclick="askTech('Termograf&iacute;a y an&aacute;lisis de puntos calientes en tableros el&eacute;ctricos')"><div class="know-item-t">Termograf&iacute;a y an&aacute;lisis de puntos calientes</div><div class="know-item-s">Consultar procedimiento t&eacute;cnico &rarr;</div></div>
      </div>
      <div class="know-cat">
        <div class="know-cat-t">&#9881;&#65039; Mec&aacute;nica</div>
        <div class="know-item" onclick="askTech('An&aacute;lisis de vibraciones en rodamientos industriales')"><div class="know-item-t">An&aacute;lisis de vibraciones en rodamientos</div><div class="know-item-s">Consultar procedimiento t&eacute;cnico &rarr;</div></div>
        <div class="know-item" onclick="askTech('Procedimiento de alineaci&oacute;n de ejes y acoplamientos')"><div class="know-item-t">Alineaci&oacute;n de ejes y acoplamientos</div><div class="know-item-s">Consultar procedimiento t&eacute;cnico &rarr;</div></div>
        <div class="know-item" onclick="askTech('Cambio de sellos mec&aacute;nicos en bombas centrif&uacute;gas')"><div class="know-item-t">Cambio de sellos mec&aacute;nicos en bombas</div><div class="know-item-s">Consultar procedimiento t&eacute;cnico &rarr;</div></div>
        <div class="know-item" onclick="askTech('Lubricaci&oacute;n de reductores y cadenas industriales')"><div class="know-item-t">Lubricaci&oacute;n de reductores y cadenas</div><div class="know-item-s">Consultar procedimiento t&eacute;cnico &rarr;</div></div>
      </div>
      <div class="know-cat">
        <div class="know-cat-t">&#127981; Proceso Papelero</div>
        <div class="know-item" onclick="askTech('Regulaci&oacute;n de consistencia en el pulper y refinadores Unionpel')"><div class="know-item-t">Regulaci&oacute;n de consistencia en el pulper</div><div class="know-item-s">Consultar procedimiento &rarr;</div></div>
        <div class="know-item" onclick="askTech('Control de gramaje en m&aacute;quina continua papelera')"><div class="know-item-t">Control de gramaje en m&aacute;quina continua</div><div class="know-item-s">Consultar procedimiento &rarr;</div></div>
        <div class="know-item" onclick="askTech('Causas y soluci&oacute;n de corte de papel en m&aacute;quina continua (web breaks)')"><div class="know-item-t">Corte de papel - web breaks</div><div class="know-item-s">Consultar procedimiento &rarr;</div></div>
        <div class="know-item" onclick="askTech('Optimizaci&oacute;n de velocidad y tensi&oacute;n en bobinadora Voith')"><div class="know-item-t">Optimizaci&oacute;n de bobinadora Voith</div><div class="know-item-s">Consultar procedimiento &rarr;</div></div>
      </div>
      <div class="know-cat">
        <div class="know-cat-t">&#128274; Seguridad Industrial</div>
        <div class="know-item" onclick="askTech('Procedimiento completo LOTO Lock Out Tag Out para trabajos en equipo')"><div class="know-item-t">Procedimiento LOTO (Lock Out Tag Out)</div><div class="know-item-s">Consultar procedimiento de seguridad &rarr;</div></div>
        <div class="know-item" onclick="askTech('Trabajo en espacios confinados en planta de papel')"><div class="know-item-t">Trabajo en espacios confinados</div><div class="know-item-s">Consultar procedimiento de seguridad &rarr;</div></div>
        <div class="know-item" onclick="askTech('Permisos de trabajo en caliente soldadura planta industrial')"><div class="know-item-t">Permisos de trabajo en caliente</div><div class="know-item-s">Consultar procedimiento de seguridad &rarr;</div></div>
      </div>
    </div>
    <div class="bot-quick-row" id="bot-quick-row">
      <span class="bot-quick" onclick="quickAsk('Estado del turno actual')">&#128203; Turno</span>
      <span class="bot-quick" onclick="quickAsk('OTs pendientes urgentes')">&#128296; OTs</span>
      <span class="bot-quick" onclick="quickAsk('Analiz&aacute; las paradas de planta recientes')">&#9940; Paradas</span>
      <span class="bot-quick" onclick="quickAsk('Dame recomendaciones de mantenimiento preventivo')">&#128161; Recomend.</span>
      <span class="bot-quick" onclick="quickAsk('Explic&aacute;me c&oacute;mo calcular el OEE')">&#128202; OEE</span>
      <span class="bot-quick" onclick="quickAsk('Consejos de seguridad para el turno')">&#9940; Seguridad</span>
    </div>
    <div class="bot-input-row">
      <textarea class="bot-input" id="bot-input" placeholder="Consult&aacute; a ARIA sobre operaci&oacute;n, mantenimiento t&eacute;cnico, diagn&oacute;stico de fallas..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendBot()}" oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,80)+'px'"></textarea>
      <button class="bot-send" id="bot-send-btn" onclick="sendBot()"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
  <button id="bot-btn" onclick="toggleBot()" title="ARIA &mdash; Asistente IA"><i class="fas fa-robot"></i></button>
</div>

<div class="modal-ov" id="gmodal" onclick="if(event.target===this)closeModal()">
  <div class="modal-box" id="mbox">
    <div class="modal-header">
      <div class="modal-title" id="mtitle">-</div>
      <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
    </div>
    <div id="mbody"></div>
  </div>
</div>

<script>
'use strict';
// ── PERSONAL DEL ORGANIGRAMA ──────────────────────────────
const PERSONAL_ALL = [
  {n:'Paz Carlos',cargo:'Gerente de Planta',area:'gerencia'},
  {n:'Fiorda Fernando',cargo:'Sub Gerente de Planta',area:'gerencia'},
  {n:'Rogel Paul',cargo:'RRHH / Administración',area:'administracion'},
  {n:'Garcia Taylor Federico',cargo:'RRHH / Administración',area:'administracion'},
  {n:'Crivellaro R.',cargo:'Seg. e Higiene',area:'seguridad'},
  {n:'Osvaldo Raab',cargo:'Resp. Corp. S&H',area:'seguridad'},
  {n:'Cerrillo Ignacio',cargo:'Jefe de Producción',area:'produccion'},
  {n:'Escobar Angel',cargo:'Jefe de Mantenimiento',area:'mantenimiento'},
  {n:'Suarez Lucas',cargo:'Jefe de Proyectos',area:'proyectos'},
  {n:'Collazo Alfredo',cargo:'Materias Primas',area:'produccion'},
  {n:'Cordero Javier',cargo:'Jefe Expedición',area:'expedicion'},
  {n:'Gaitan Gastón',cargo:'Supervisor Producción',area:'produccion'},
  {n:'Ericsson Samuel',cargo:'Supervisor Mantenimiento',area:'mantenimiento'},
  {n:'Sachetti Luis',cargo:'Supervisor Mantenimiento',area:'mantenimiento'},
  {n:'Guevara Agustín',cargo:'Supervisor Mantenimiento',area:'mantenimiento'},
  {n:'Chaparro Cristian',cargo:'Líder de Turno',area:'produccion'},
  {n:'Amendolara Fabián',cargo:'Lubricador',area:'mantenimiento'},
  {n:'Acosta Cristian',cargo:'Instrumentista',area:'mantenimiento'},
  {n:'Ramaglia Carlos',cargo:'Eléctrico',area:'mantenimiento'},
  {n:'Zeballos Leandro',cargo:'Eléctrico',area:'mantenimiento'},
  {n:'Sosa Mauricio',cargo:'Eléctrico',area:'mantenimiento'},
  {n:'Vargas Lautaro',cargo:'Eléctrico',area:'mantenimiento'},
  {n:'Cassal Sergio',cargo:'Mecánico',area:'mantenimiento'},
  {n:'Ovejero Nicolás',cargo:'Mecánico',area:'mantenimiento'},
  {n:'Aubia Santiago',cargo:'Ing. Mantenimiento',area:'mantenimiento'},
  {n:'Baez Emiliano',cargo:'Confiabilidad',area:'mantenimiento'},
  {n:'Fretes Leandro',cargo:'Confiabilidad',area:'mantenimiento'},
  {n:'Bernachea G.',cargo:'Pañolero',area:'mantenimiento'},
  {n:'Aparicio Dardo',cargo:'Pañolero',area:'mantenimiento'},
  {n:'Di Minico',cargo:'Compras',area:'administracion'},
  {n:'González de la Mata',cargo:'Auxiliar',area:'produccion'},
  {n:'Ortiz Dario',cargo:'Cond. Máq. Continua',area:'produccion'},
  {n:'Flores Fabián',cargo:'Cond. Máq. Continua',area:'produccion'},
  {n:'Ruiz Ariel',cargo:'Cond. Máq. Continua',area:'produccion'},
  {n:'Ayala L.',cargo:'Cond. Máq. Continua',area:'produccion'},
  {n:'Herrera Walter',cargo:'Bobinadora Voith',area:'produccion'},
  {n:'Coria Sánchez',cargo:'Bobinadora Voith',area:'produccion'},
  {n:'Martinez Carlos',cargo:'Bobinadora Voith',area:'produccion'},
  {n:'Colque Fernando',cargo:'Bobinadora Voith',area:'produccion'},
  {n:'Soberon Jose',cargo:'Ayudante',area:'produccion'},
  {n:'Aranda Alan',cargo:'Ayudante',area:'produccion'},
  {n:'Souza Gabriel',cargo:'Ayudante',area:'produccion'},
  {n:'Quilici Jorge',cargo:'Ayudante',area:'produccion'},
  {n:'Morenate Leandro',cargo:'Ayudante',area:'produccion'},
  {n:'Cardozo Daniel',cargo:'Ayudante',area:'produccion'},
  {n:'Benitez Andrés',cargo:'Ayudante',area:'produccion'},
  {n:'Rios Kevin',cargo:'Ayudante',area:'produccion'},
  {n:'Palacio J.',cargo:'Pulper',area:'produccion'},
  {n:'Camaño Alfredo',cargo:'Pulper',area:'produccion'},
  {n:'Daluz',cargo:'Pulper',area:'produccion'},
  {n:'Villafañes Ariel',cargo:'Pulper',area:'produccion'},
  {n:'Moroni Santiago',cargo:'Pulper',area:'produccion'},
  {n:'Teves Ezequiel',cargo:'Relevante',area:'produccion'},
  {n:'Burgos Manuel',cargo:'Relevante',area:'produccion'},
  {n:'Rodriguez Walter',cargo:'Relevante',area:'produccion'},
  {n:'Ricci Santiago',cargo:'Relevante',area:'produccion'},
  {n:'Dominguez M.',cargo:'Cond. Autoelevador',area:'produccion'},
  {n:'Baldonado Miguel',cargo:'Cond. Autoelevador',area:'produccion'},
  {n:'Ocaranza Gonzalo',cargo:'Cond. Autoelevador',area:'expedicion'},
  {n:'Ugarte Luis',cargo:'Cond. Autoelevador',area:'expedicion'},
  {n:'Ruidiaz Gustavo',cargo:'Patio / Maestranza',area:'produccion'},
  {n:'Gomez Marcelo',cargo:'Balanza',area:'produccion'},
];

// ── CHECKLIST ITEMS ───────────────────────────────────────
const CL = [
  {id:'ci_presion',g:'Contra Incendios',l:'Presión de línea entre 4.5 y 6 bar',t:'si_no'},
  {id:'ci_nivel',g:'Contra Incendios',l:'Nivel pileta estación contra incendios correcto',t:'si_no'},
  {id:'ci_gasoil',g:'Contra Incendios',l:'Nivel de gasoil pileta (describir)',t:'texto'},
  {id:'cal_presion',g:'Caldera Gonella',l:'Presión de vapor entre 11 y 13 bar',t:'si_no'},
  {id:'cal_nivel',g:'Caldera Gonella',l:'Nivel de agua visible',t:'si_no'},
  {id:'cal_gases',g:'Caldera Gonella',l:'Temperatura gases < 280°C',t:'si_no'},
  {id:'cal_canerias',g:'Caldera Gonella',l:'Ausencia de pérdidas en cañerías',t:'si_no'},
  {id:'cal_purga',g:'Caldera Gonella',l:'Se realizó purga de fondo y superficie',t:'si_no'},
  {id:'cal_condensado',g:'Caldera Gonella',l:'Nivel tanque de condensado (%)',t:'texto'},
  {id:'osm_ok',g:'Osmosis / Compresores',l:'Osmosis inversa encendida y sin fallas',t:'si_no'},
  {id:'comp_rad',g:'Osmosis / Compresores',l:'Radiadores compresores limpios',t:'si_no'},
  {id:'comp_sullair',g:'Osmosis / Compresores',l:'Compresor Sullair disponible y sin alarma',t:'si_no'},
  {id:'comp_kaeser',g:'Osmosis / Compresores',l:'Compresor Kaeser disponible y sin alarma',t:'si_no'},
  {id:'comp_secador',g:'Osmosis / Compresores',l:'Secador Sullair encendido y sin alarma',t:'si_no'},
  {id:'comp_presion',g:'Osmosis / Compresores',l:'Presión aire TK pulmón entre 6 y 8 bar',t:'si_no'},
  {id:'comp_enmarcha',g:'Osmosis / Compresores',l:'Compresor en marcha',t:'select_comp'},
  {id:'ref1_fallas',g:'Refinadores / Pulper',l:'Refinador 1 - ausencia de fallas',t:'si_no'},
  {id:'ref1_auto',g:'Refinadores / Pulper',l:'Refinador 1 - seleccionado en automático',t:'si_no'},
  {id:'ref2_fallas',g:'Refinadores / Pulper',l:'Refinador 2 - ausencia de fallas',t:'si_no'},
  {id:'ref2_auto',g:'Refinadores / Pulper',l:'Refinador 2 - seleccionado en automático',t:'si_no'},
  {id:'ref_refrig',g:'Refinadores / Pulper',l:'Refrigeración motores refinadores OK y filtros de guata limpios',t:'si_no'},
  {id:'ref_presion',g:'Refinadores / Pulper',l:'Refinadores 1 y 2 - presión trabajo, aceite y agua sello OK (describir)',t:'texto'},
  {id:'pulper_correas',g:'Refinadores / Pulper',l:'Pulper Andritz - estado de correas correcto',t:'si_no'},
  {id:'pulper_caudal',g:'Refinadores / Pulper',l:'Pulper Andritz - caudal agua sello 0.5 a 2 lt/min',t:'si_no'},
  {id:'pulper_presion',g:'Refinadores / Pulper',l:'Pulper Andritz - presión agua sello 1.5 bar',t:'si_no'},
  {id:'pulper_aceite',g:'Refinadores / Pulper',l:'Pulper Andritz - aceite en bomba de descarga',t:'si_no'},
  {id:'tab_pulper',g:'Tableros',l:'Tablero general pulper - limpio, ordenado y cerrado',t:'si_no'},
  {id:'tab_continua',g:'Tableros',l:'Tablero general máquina continua - limpio, ordenado y cerrado',t:'si_no'},
  {id:'tab_bobinad',g:'Tableros',l:'Tablero general bobinadora - limpio, ordenado y cerrado',t:'si_no'},
  {id:'mc_fan',g:'Máquina Continua',l:'Refrigeración bomba Fan - circulación agua en empaquetadura',t:'si_no'},
  {id:'mc_temp',g:'Máquina Continua',l:'Temperatura reductores < 70°C',t:'si_no'},
  {id:'mc_purga',g:'Máquina Continua',l:'Bombas alta y media presión - ausencia de sólidos en purga',t:'si_no'},
  {id:'mc_piletas',g:'Máquina Continua',l:'Bombas y reductores piletas 1,2,4,5 - nivel aceite OK, sin pérdidas (describir)',t:'texto'},
  {id:'mc_interc',g:'Máquina Continua',l:'Intercambiadores - circulación agua y aceite',t:'si_no'},
  {id:'mc_mp_aceite',g:'Máquina Continua',l:'Bombas alta y media presión - sin pérdida aceite, nivel OK (describir)',t:'texto'},
  {id:'mc_mp_refrig',g:'Máquina Continua',l:'Refrigeración motores MP - funcionando y filtros de guata limpios',t:'si_no'},
  {id:'mc_central',g:'Máquina Continua',l:'Centralina monolúcido - todos los LED en verde',t:'si_no'},
  {id:'rep_agitador',g:'Repulper',l:'Agitador repulper - ausencia de pérdidas por empaquetadura',t:'si_no'},
  {id:'rep_correas',g:'Repulper',l:'Agitador repulper - estado de correas correcto',t:'si_no'},
  {id:'rep_nivel',g:'Repulper',l:'Fosa repulper - nivel batea normal',t:'si_no'},
  {id:'rep_bomba',g:'Repulper',l:'Bomba repulper - estado aceite, sin pérdidas de aceite ni pasta (describir)',t:'texto'},
  {id:'nash_ok',g:'Vacío / Nash',l:'Bombas Nash - funcionamiento normal',t:'si_no'},
  {id:'nash_sello',g:'Vacío / Nash',l:'Bomba agua sello vacío - presión > 1 bar',t:'si_no'},
  {id:'bob_portacuch',g:'Bobinadora Voith',l:'Número de portacuchillas disponibles',t:'numero'},
  {id:'bob_punteras',g:'Bobinadora Voith',l:'Número de punteras disponibles',t:'numero'},
  {id:'bob_interc',g:'Bobinadora Voith',l:'Circulación agua en intercambiador',t:'si_no'},
  {id:'bob_mot_cc',g:'Bobinadora Voith',l:'Motores CC - guatas OK, sin pérdidas aceite, nivel OK (describir)',t:'texto'},
  {id:'bob_central',g:'Bobinadora Voith',l:'Centralina hidráulica bobinadora - OK, nivel, sin pérdidas (describir)',t:'texto'},
  {id:'bob_refrig',g:'Bobinadora Voith',l:'Refrigeración motores rebobinadora - funcionando y filtros guata limpios',t:'si_no'},
  {id:'bomb_efluentes',g:'Bombas / Selección',l:'Bombas efluentes - seleccionada (1/2) y backup',t:'sel_bomba'},
  {id:'bomb_caldera',g:'Bombas / Selección',l:'Bombas caldera - seleccionada (1/2) y backup',t:'sel_bomba'},
  {id:'bomb_condensado',g:'Bombas / Selección',l:'Bombas condensado - seleccionada (1/2) y backup',t:'sel_bomba'},
  {id:'bomb_medpres',g:'Bombas / Selección',l:'Bombas media presión (continua) - seleccionada y backup',t:'sel_bomba'},
  {id:'bomb_altpres',g:'Bombas / Selección',l:'Bombas alta presión (continua) - seleccionada y backup',t:'sel_bomba'},
  {id:'bomb_sello',g:'Bombas / Selección',l:'Bombas sello vacío - seleccionada y backup',t:'sel_bomba'},
  {id:'sot_rep_flt',g:'Sótanos',l:'Sótano Repulper - prueba flotante OK',t:'si_no'},
  {id:'sot_rep_per',g:'Sótanos',l:'Sótano Repulper - ausencia de pérdidas',t:'si_no'},
  {id:'sot_fan_flt',g:'Sótanos',l:'Sótano Fan - prueba flotante OK',t:'si_no'},
  {id:'sot_fan_per',g:'Sótanos',l:'Sótano Fan - ausencia de pérdidas',t:'si_no'},
  {id:'sot_pil_flt',g:'Sótanos',l:'Sótano Piletas - prueba flotante OK',t:'si_no'},
  {id:'sot_pil_per',g:'Sótanos',l:'Sótano Piletas - ausencia de pérdidas',t:'si_no'},
  {id:'pgr_c5_func',g:'Puentes Grúa',l:'Puente grúa Continua 5Tn - funcionamiento normal',t:'si_no'},
  {id:'pgr_c5_btn',g:'Puentes Grúa',l:'Puente grúa Continua 5Tn - botonera sin fallas',t:'si_no'},
  {id:'pgr_ap1_func',g:'Puentes Grúa',l:'Puente grúa Aparejo 1Tn - funcionamiento normal',t:'si_no'},
  {id:'pgr_ap1_btn',g:'Puentes Grúa',l:'Puente grúa Aparejo 1Tn - botonera sin fallas',t:'si_no'},
  {id:'pgr_b10_func',g:'Puentes Grúa',l:'Puente grúa Bobinadora 10Tn - funcionamiento normal',t:'si_no'},
  {id:'pgr_b10_btn',g:'Puentes Grúa',l:'Puente grúa Bobinadora 10Tn - botonera sin fallas',t:'si_no'},
  {id:'est_prep',g:'Estado General',l:'Preparación de pasta - funcionamiento normal',t:'si_no'},
  {id:'est_maq',g:'Estado General',l:'Máquina de Papel Continua - funcionamiento normal',t:'si_no'},
  {id:'est_bob',g:'Estado General',l:'Bobinadora Voith - funcionamiento normal',t:'si_no'},
  {id:'est_filtro',g:'Estado General',l:'Filtro de barros - funcionamiento normal',t:'si_no'},
];
const GRUPOS = [...new Set(CL.map(i=>i.g))];

// ── EQUIPOS OT ───────────────────────────────────────────
const EQUIPOS_OT = ['PM-1 Máquina de Papel Continua','Pulper Andritz','Bobinadora Voith','Refinador 1','Refinador 2','Caldera Gonella','Compresor Sullair','Compresor Kaeser','Bomba Alta Presión 1','Bomba Alta Presión 2','Bomba Media Presión 1','Bomba Media Presión 2','Bomba Nash 1','Bomba Nash 2','Bomba Caldera','Bomba Condensado','Bomba Efluentes','Bomba Sello Vacío','Centralina Hidráulica Bobinadora','Puente Grúa 5Tn Continua','Puente Grúa 1Tn Aparejo','Puente Grúa 10Tn Bobinadora','Filtro de Barros','Agitador Repulper','Intercambiador de Calor','Osmosis Inversa','Tablero Eléctrico','Otros'];

// ── USERS ─────────────────────────────────────────────────
const USERS = {
  admin:{name:'Administrador Sistema',role:'Administrador',initials:'AD',area:'Sistemas',perms:['all'],pass:'Unionpel 2026'},
  cerrillo:{name:'Cerrillo Ignacio',role:'Jefe Producción',initials:'CI',area:'Producción',perms:['all'],pass:'Unionpel 2026'},
  escobar:{name:'Escobar Angel',role:'Jefe Mantenimiento',initials:'EA',area:'Mantenimiento',perms:['all'],pass:'Unionpel 2026'},
  gaitan:{name:'Gaitan Gastón',role:'Supervisor',initials:'GG',area:'Producción',perms:['dashboard','turno','historial','ots','paradas','reportes'],pass:'Unionpel 2026'},
  amendolara:{name:'Amendolara Fabián',role:'Técnico',initials:'AF',area:'Mantenimiento',perms:['dashboard','turno','historial'],pass:'Unionpel 2026'},
  ramaglia:{name:'Ramaglia Carlos',role:'Técnico',initials:'RC',area:'Mantenimiento',perms:['dashboard','turno','historial'],pass:'Unionpel 2026'},
  zeballos:{name:'Zeballos Leandro',role:'Técnico',initials:'ZL',area:'Mantenimiento',perms:['dashboard','turno','historial'],pass:'Unionpel 2026'},
  cassal:{name:'Cassal Sergio',role:'Técnico',initials:'CS',area:'Mantenimiento',perms:['dashboard','turno','historial'],pass:'Unionpel 2026'},
  ovejero:{name:'Ovejero Nicolás',role:'Técnico',initials:'ON',area:'Mantenimiento',perms:['dashboard','turno','historial'],pass:'Unionpel 2026'},
  sosa:{name:'Sosa Mauricio',role:'Técnico',initials:'SM',area:'Mantenimiento',perms:['dashboard','turno','historial'],pass:'Unionpel 2026'},
  vargas:{name:'Vargas Lautaro',role:'Técnico',initials:'VL',area:'Mantenimiento',perms:['dashboard','turno','historial'],pass:'Unionpel 2026'},
  acosta:{name:'Acosta Cristian',role:'Técnico',initials:'AC',area:'Mantenimiento',perms:['dashboard','turno','historial'],pass:'Unionpel 2026'},
};

// ── STATE ─────────────────────────────────────────────────
const S={user:null,mod:'dashboard',checks:[],ots:[],paradas:[],notifs:[]};

function loadS(){ try{ S.checks=JSON.parse(localStorage.getItem('rpm5_ch')||'[]'); S.ots=JSON.parse(localStorage.getItem('rpm5_ot')||'[]'); S.paradas=JSON.parse(localStorage.getItem('rpm5_pa')||'[]'); }catch(e){} }
function saveS(){ localStorage.setItem('rpm5_ch',JSON.stringify(S.checks)); localStorage.setItem('rpm5_ot',JSON.stringify(S.ots)); localStorage.setItem('rpm5_pa',JSON.stringify(S.paradas)); updateCounts(); }
function updateCounts(){
  const t=S.checks.length+S.ots.length+S.paradas.length;
  const el=document.getElementById('sys-cnt'); if(el) el.textContent=t;
  const sb=document.getElementById('sb-ot-c'); if(sb) sb.textContent=S.ots.filter(o=>o.estado==='pendiente').length;
}
function hasP(mod){ if(!S.user) return false; return S.user.perms.includes('all')||S.user.perms.includes(mod); }

// ── AUTH ──────────────────────────────────────────────────
function doLogin(){
  const u=document.getElementById('login-user').value.trim().toLowerCase();
  const p=document.getElementById('login-pass').value;
  const err=document.getElementById('auth-error');
  if(USERS[u]&&USERS[u].pass===p){
    S.user={...USERS[u],username:u};
    localStorage.setItem('rpm5_sess',JSON.stringify(S.user));
    bootApp(); err.style.display='none';
  } else { err.style.display='block'; setTimeout(()=>err.style.display='none',3000); }
}
function doLogout(){ localStorage.removeItem('rpm5_sess'); location.reload(); }

function bootApp(){
  document.getElementById('auth-screen').style.display='none';
  document.getElementById('app').style.display='flex';
  document.getElementById('bot-container').style.display='block';
  document.getElementById('nav-uname').textContent=S.user.name;
  document.getElementById('nav-urole').textContent=S.user.role;
  document.getElementById('nav-av').textContent=S.user.initials;
  document.getElementById('um-name').textContent=S.user.name;
  document.getElementById('um-role').textContent=S.user.role;
  loadS(); updateCounts(); buildNotifList();
  const hora = new Date().getHours();
  const saludo = hora < 12 ? 'Buenos días' : hora < 19 ? 'Buenas tardes' : 'Buenas noches';
  botAdd(`<strong>${saludo}, ${S.user.name.split(' ')[0]}.</strong><br>Soy <strong>ARIA</strong>, tu asistente de ingeniería industrial en RPM_360.<br><br>Como Ing. en Sistemas e Ing. Electromecánico estoy aquí para ayudarte con:<br>• Diagnóstico técnico de equipos<br>• Análisis del estado de la planta<br>• Capacitación y procedimientos<br>• Gestión de OTs y mantenimiento<br><br>Puedo leer los datos del turno en tiempo real. <strong>¿Qué necesitás?</strong>`,'bot');
  updateClock(); setInterval(updateClock,1000);
  navigate('dashboard');
}
function updateClock(){
  const n=new Date();
  const c=document.getElementById('nav-clock'); if(c) c.textContent=n.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'});
  const d=document.getElementById('nav-date'); if(d) d.textContent=n.toLocaleDateString('es-AR',{day:'2-digit',month:'2-digit',year:'numeric'});
}

// ── ROUTER ────────────────────────────────────────────────
const MODS={dashboard,turno,historial,ots,paradas,energia,proceso,reportes,personal,configuracion};
function navigate(mod){
  if(!hasP(mod)&&mod!=='dashboard'){ openModal('Sin Acceso','<div class="alert alert-warn"><i class="fas fa-lock" style="margin-right:8px"></i>No tenés permisos. Contactá al administrador.</div>'); return; }
  S.mod=mod;
  document.querySelectorAll('.sb-item').forEach(el=>el.classList.toggle('active',el.dataset.mod===mod));
  const c=document.getElementById('content'); c.innerHTML='';
  if(MODS[mod]) MODS[mod](c);
  document.getElementById('notif-panel').classList.remove('open');
  document.getElementById('user-menu').classList.remove('open');
  c.scrollTop=0;
}

// ── MODAL ─────────────────────────────────────────────────
function openModal(title,body,lg=false){
  document.getElementById('mtitle').textContent=title;
  document.getElementById('mbody').innerHTML=body;
  document.getElementById('mbox').className='modal-box'+(lg?' mlg':'');
  document.getElementById('gmodal').classList.add('open');
}
function closeModal(){ document.getElementById('gmodal').classList.remove('open'); }

// ── CHART DEFAULTS ────────────────────────────────────────
const CD={responsive:true,maintainAspectRatio:true,
  plugins:{legend:{labels:{color:'#8AABCC',font:{family:"'Barlow'",size:12}}}},
  scales:{x:{grid:{color:'rgba(0,102,179,0.05)'},ticks:{color:'#4A6880',font:{family:"'JetBrains Mono'",size:11}}},
          y:{grid:{color:'rgba(0,102,179,0.05)'},ticks:{color:'#4A6880',font:{family:"'JetBrains Mono'",size:11}}}}};

// ══════════════════════════════════════════════════════════
// DASHBOARD
// ══════════════════════════════════════════════════════════
function dashboard(el){
  const hoy=new Date().toLocaleDateString('es-AR');
  const chHoy=S.checks.filter(c=>c.fecha===hoy);
  const otsPend=S.ots.filter(o=>o.estado==='pendiente').length;
  const hrsP=S.paradas.reduce((a,p)=>a+(parseFloat(p.duracion)||0),0);
  el.innerHTML=`<div class="module">
    <div class="ph">
      <div>
        <div class="pt">Dashboard <span>360°</span></div>
        <div class="ps">Vista operativa — Unionpel Pacheco · ${new Date().toLocaleDateString('es-AR',{weekday:'long',day:'2-digit',month:'long',year:'numeric'})}</div>
      </div>
      <div class="pa">
        <button class="btn btn-secondary btn-sm" onclick="navigate('reportes')"><i class="fas fa-file-chart-column"></i> Reportes</button>
        ${hasP('turno')?`<button class="btn btn-primary btn-sm" onclick="navigate('turno')"><i class="fas fa-clipboard-check"></i> Cargar Turno</button>`:''}
      </div>
    </div>
    <!-- Welcome strip -->
    <div style="background:linear-gradient(135deg,var(--up-dark) 0%,var(--up-blue) 50%,var(--up-sky) 100%);border-radius:var(--rl);padding:20px 26px;display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;position:relative;overflow:hidden">
      <div style="position:absolute;right:-20px;top:-20px;width:180px;height:180px;border-radius:50%;background:rgba(255,255,255,.05)"></div>
      <div style="position:absolute;right:60px;bottom:-40px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.04)"></div>
      <div style="position:relative">
        <div style="font-family:var(--font-d);font-size:22px;font-weight:900;color:#fff">Bienvenido, ${S.user.name}</div>
        <div style="font-size:13px;color:rgba(255,255,255,.7);margin-top:2px">${S.user.role} · ${S.user.area} · RPM_360 v5.0 · Unionpel Pacheco</div>
      </div>
      <div style="text-align:right;position:relative">
        <div style="font-family:var(--font-m);font-size:30px;font-weight:700;color:#fff" id="big-clk">--:--</div>
        <div style="font-size:12px;color:rgba(255,255,255,.6)">${hoy}</div>
      </div>
    </div>
    <!-- KPIs -->
    <div class="kpi-grid" style="grid-template-columns:repeat(4,1fr)">
      <div class="kpi-card kpi-blue"><div class="kpi-label">Checks Hoy</div><div class="kpi-value">${chHoy.length}</div><div class="kpi-sub">${S.checks.length} registros totales</div><i class="fas fa-clipboard-check kpi-icon"></i></div>
      <div class="kpi-card kpi-lime"><div class="kpi-label">OTs Pendientes</div><div class="kpi-value">${otsPend}</div><div class="kpi-sub">${S.ots.length} OTs totales</div><i class="fas fa-tools kpi-icon"></i></div>
      <div class="kpi-card kpi-amber"><div class="kpi-label">Paradas Reg.</div><div class="kpi-value">${S.paradas.length}</div><div class="kpi-sub">${hrsP.toFixed(1)}h acumuladas</div><i class="fas fa-stopwatch kpi-icon"></i></div>
      <div class="kpi-card kpi-sky"><div class="kpi-label">OEE Estimado</div><div class="kpi-value">87.4<small style="font-size:18px">%</small></div><div class="kpi-sub"><span class="kpi-up"><i class="fas fa-arrow-up"></i> +2.3%</span> vs anterior</div><i class="fas fa-tachometer-alt kpi-icon"></i></div>
    </div>
    <!-- Charts -->
    <div class="grid-2" style="margin-bottom:16px">
      <div class="card"><div class="card-header"><span class="card-title">Disponibilidad — 6 meses</span><span class="badge b-blue b-dot">Tendencia</span></div><div class="chart-wrap"><canvas id="ch-av"></canvas></div></div>
      <div class="card"><div class="card-header"><span class="card-title">Distribución de Paradas</span><span class="badge b-blue b-dot">Actual</span></div>
        <div style="display:flex;align-items:center;gap:20px">
          <canvas id="ch-dn" style="max-width:170px;max-height:170px"></canvas>
          <div style="flex:1">
            ${[['Mecánico','#E8391A','42%'],['Eléctrico','#0066B3','28%'],['Proceso','#00A3E0','18%'],['Otros','#4A6880','12%']].map(([l,c,v])=>`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div style="display:flex;align-items:center;gap:8px"><div style="width:9px;height:9px;border-radius:2px;background:${c}"></div><span style="font-size:13px;color:var(--text-2)">${l}</span></div><span style="font-family:var(--font-m);font-size:13px;color:var(--text-1);font-weight:700">${v}</span></div>`).join('')}
          </div>
        </div>
      </div>
    </div>
    <!-- Últimos registros -->
    <div class="grid-2">
      <div class="card" style="border-top:2px solid var(--up-blue)">
        <div class="card-header"><span class="card-title"><i class="fas fa-clipboard-check" style="color:var(--up-sky);margin-right:8px"></i>Últimos Turnos</span><button class="btn btn-ghost btn-xs" onclick="navigate('historial')">Ver todos →</button></div>
        ${S.checks.length===0
          ?'<div style="text-align:center;padding:30px;color:var(--text-3)"><i class="fas fa-inbox" style="font-size:36px;display:block;margin-bottom:10px;opacity:.4"></i>Sin registros todavía.<br><button class="btn btn-primary btn-sm" style="margin-top:10px" onclick="navigate(\'turno\')"><i class="fas fa-plus"></i> Cargar turno</button></div>'
          :S.checks.slice(-5).reverse().map(c=>{const tc={mañana:'var(--amber)',tarde:'var(--up-sky)',noche:'#a78bfa'}[c.turno]||'var(--text-3)';return `<div style="display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--border)"><div><div style="font-size:13px;font-weight:700;color:var(--text-1)">${c.tecnico_nombre}</div><div style="font-size:11px;color:var(--text-3);margin-top:1px">${c.fecha} · <span style="color:${tc};font-weight:800;text-transform:uppercase;font-size:10px">${c.turno}</span></div></div><span class="badge ${c.obs_count>0?'b-amber':'b-green'}">${c.obs_count} obs</span></div>`;}).join('')}
      </div>
      <div class="card" style="border-top:2px solid var(--up-sky)">
        <div class="card-header"><span class="card-title"><i class="fas fa-tools" style="color:var(--amber);margin-right:8px"></i>OTs Recientes</span><button class="btn btn-primary btn-xs" onclick="navigate('ots')"><i class="fas fa-plus"></i> Nueva</button></div>
        ${S.ots.length===0
          ?'<div style="text-align:center;padding:30px;color:var(--text-3)"><i class="fas fa-tools" style="font-size:36px;display:block;margin-bottom:10px;opacity:.4"></i>Sin OTs.<br><button class="btn btn-primary btn-sm" style="margin-top:10px" onclick="navigate(\'ots\')"><i class="fas fa-plus"></i> Crear OT</button></div>'
          :S.ots.slice(-5).reverse().map(o=>{const bc={pendiente:'b-amber',proceso:'b-blue',completada:'b-green'}[o.estado]||'b-gray';return `<div style="display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--border)"><div><div style="font-size:13px;font-weight:700;color:var(--text-1)">${o.titulo}</div><div style="font-size:11px;color:var(--text-3);margin-top:1px">${o.equipo.split(' ').slice(0,3).join(' ')} · ${o.fecha}</div></div><span class="badge ${bc}">${o.estado}</span></div>`;}).join('')}
      </div>
    </div>
    <!-- Energy strip -->
    <div class="grid-4" style="margin-top:16px">
      ${[['Energía Eléctrica','fas fa-bolt','var(--amber)','rgba(245,166,35,.1)','1,842 kWh'],['Consumo Agua','fas fa-tint','var(--up-sky)','rgba(0,163,224,.1)','347 m³'],['Gas Natural','fas fa-fire','#FF7A5C','rgba(232,57,26,.1)','28.4 mmBTU'],['Vapor','fas fa-wind','var(--teal)','rgba(0,196,167,.1)','12.8 t/h']].map(([l,ic,tc,bg,v])=>`<div style="background:var(--ink-3);border:1px solid var(--border);border-top:2px solid ${tc};border-radius:var(--rl);padding:16px"><div style="display:flex;align-items:center;gap:10px;margin-bottom:10px"><div style="width:36px;height:36px;border-radius:var(--r);background:${bg};display:flex;align-items:center;justify-content:center;font-size:15px;color:${tc}"><i class="${ic}"></i></div><div><div style="font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:.1em;font-weight:700">${l}</div><div style="font-family:var(--font-d);font-size:20px;font-weight:900;color:var(--text-1)">${v}</div></div></div><div class="prog-bar"><div class="prog-bar-fill" style="background:${tc};width:${60+Math.random()*30}%"></div></div></div>`).join('')}
    </div>
  </div>`;
  const bc=()=>{const e=document.getElementById('big-clk');if(e)e.textContent=new Date().toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'})};
  bc(); setInterval(bc,1000);
  setTimeout(()=>{
    const ctx1=document.getElementById('ch-av');
    if(ctx1) new Chart(ctx1,{type:'line',data:{labels:['Sep','Oct','Nov','Dic','Ene','Feb'],datasets:[{label:'Disponibilidad %',data:[89.2,91.5,88.7,92.1,90.8,94.2],borderColor:'#0066B3',backgroundColor:'rgba(0,102,179,.08)',borderWidth:2.5,tension:.4,fill:true,pointBackgroundColor:'#00A3E0',pointRadius:5},{label:'Meta 95%',data:[95,95,95,95,95,95],borderColor:'var(--lime)',borderWidth:1.5,borderDash:[6,4],pointRadius:0}]},options:{...CD,scales:{...CD.scales,y:{...CD.scales.y,min:80,max:100}}}});
    const ctx2=document.getElementById('ch-dn');
    if(ctx2) new Chart(ctx2,{type:'doughnut',data:{labels:['Mecánico','Eléctrico','Proceso','Otros'],datasets:[{data:[42,28,18,12],backgroundColor:['#E8391A','#0066B3','#00A3E0','#4A6880'],borderWidth:0,hoverOffset:8}]},options:{responsive:true,maintainAspectRatio:true,cutout:'72%',plugins:{legend:{display:false}}}});
  },50);
}

// ══════════════════════════════════════════════════════════
// TURNO - REGISTRO DE TURNO
// ══════════════════════════════════════════════════════════
function turno(el){
  const responsables=PERSONAL_ALL.filter(p=>['produccion','mantenimiento'].includes(p.area)).map(p=>p.n).sort();
  el.innerHTML=`<div class="module">
    <div class="ph">
      <div>
        <div class="pt"><i class="fas fa-clipboard-check" style="color:var(--up-sky);margin-right:10px"></i>Registro de <span>Turno</span></div>
        <div class="ps">Checklist de recorrida · ${new Date().toLocaleDateString('es-AR',{weekday:'long',day:'2-digit',month:'long'})} · Unionpel Pacheco</div>
      </div>
      <div class="pa"><button class="btn btn-ghost btn-sm" onclick="navigate('historial')"><i class="fas fa-history"></i> Historial</button></div>
    </div>
    <div class="card" style="margin-bottom:16px;border-top:2px solid var(--up-blue)">
      <div class="card-header"><span class="card-title"><i class="fas fa-user-clock" style="color:var(--up-sky);margin-right:8px"></i>Datos del Turno</span></div>
      <div class="fg-3">
        <div class="fg"><label class="fl">Fecha</label><input class="fi" type="date" id="t_fecha" value="${new Date().toISOString().split('T')[0]}"></div>
        <div class="fg"><label class="fl">Turno</label>
          <select class="fs" id="t_turno">
            <option value="mañana">☀️ Mañana (06:00 — 14:00)</option>
            <option value="tarde">🌤️ Tarde (14:00 — 22:00)</option>
            <option value="noche">🌙 Noche (22:00 — 06:00)</option>
          </select>
        </div>
        <div class="fg"><label class="fl">Técnico de Turno</label>
          <select class="fs" id="t_tecnico">
            <option value="${S.user.name}" selected>${S.user.name} (yo)</option>
            ${responsables.filter(r=>r!==S.user.name).map(r=>`<option value="${r}">${r}</option>`).join('')}
          </select>
        </div>
      </div>
    </div>
    <div class="card" style="padding:0;overflow:hidden;border-top:2px solid var(--up-blue);margin-bottom:16px">
      <div class="tab-bar">${GRUPOS.map((g,i)=>`<button class="tab-btn ${i===0?'active':''}" onclick="swTab(this,'tp_${i}')">${g}</button>`).join('')}</div>
      ${GRUPOS.map((g,i)=>`<div id="tp_${i}" class="tab-panel ${i===0?'active':''}">
        ${CL.filter(ci=>ci.g===g).map(item=>clItem(item)).join('')}
      </div>`).join('')}
    </div>
    <div class="card" style="margin-bottom:16px;border-left:3px solid var(--amber)">
      <div class="card-header"><span class="card-title"><i class="fas fa-comment-alt" style="color:var(--amber);margin-right:8px"></i>Observaciones Generales del Turno</span></div>
      <textarea class="fta" id="t_obs" rows="4" placeholder="Observaciones importantes, anomalías, trabajos realizados, novedades de guardia..."></textarea>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
      <button class="btn btn-ghost" onclick="if(confirm('¿Limpiar formulario?'))navigate('turno')"><i class="fas fa-eraser"></i> Limpiar</button>
      <button class="btn btn-primary" style="font-size:15px;padding:12px 30px;font-family:var(--font-d);font-weight:900;letter-spacing:.08em" onclick="guardarTurno()"><i class="fas fa-save"></i> GUARDAR REGISTRO DE TURNO</button>
    </div>
  </div>`;
  const h=new Date().getHours(); const ts=document.getElementById('t_turno');
  if(h>=6&&h<14) ts.value='mañana'; else if(h>=14&&h<22) ts.value='tarde'; else ts.value='noche';
}

function clItem(item){
  if(item.t==='si_no') return `<div class="cl-item"><span class="cl-label">${item.l}</span><div class="cl-ctrls"><div class="rg"><label class="ro si"><input type="radio" name="${item.id}" value="SI"> SI</label><label class="ro no"><input type="radio" name="${item.id}" value="NO"> NO</label></div><input class="cl-obs" type="text" id="${item.id}_obs" placeholder="Observación..."></div></div>`;
  if(item.t==='texto') return `<div class="cl-item" style="flex-direction:column;align-items:flex-start;gap:6px"><span class="cl-label" style="padding-right:0">${item.l}</span><input class="fi" type="text" id="${item.id}" placeholder="Descripción..." style="width:100%"></div>`;
  if(item.t==='numero') return `<div class="cl-item"><span class="cl-label">${item.l}</span><input type="number" id="${item.id}" min="0" max="30" class="fi" style="width:80px;text-align:center" placeholder="0"></div>`;
  if(item.t==='sel_bomba') return `<div class="cl-item"><span class="cl-label">${item.l}</span><div class="cl-ctrls"><select class="fs" id="${item.id}_sel" style="width:100px;padding:5px 8px;font-size:12px"><option value="1">Bomba 1</option><option value="2">Bomba 2</option></select><label style="display:flex;align-items:center;gap:4px;font-size:12px;color:var(--text-2);cursor:pointer"><input type="checkbox" id="${item.id}_bk" style="accent-color:var(--up-blue)"> Backup OK</label></div></div>`;
  if(item.t==='select_comp') return `<div class="cl-item"><span class="cl-label">${item.l}</span><select class="fs" id="${item.id}" style="width:140px;padding:5px 8px;font-size:12px"><option value="SULLAIR">Sullair</option><option value="KAESER">Kaeser</option><option value="AMBOS">Ambos</option></select></div>`;
  return '';
}

function swTab(btn,tabId){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  btn.classList.add('active'); document.getElementById(tabId).classList.add('active');
}

function guardarTurno(){
  const fecha=document.getElementById('t_fecha').value;
  const turno=document.getElementById('t_turno').value;
  const tecnico_nombre=document.getElementById('t_tecnico').value;
  const obs_general=document.getElementById('t_obs').value.trim();
  if(!fecha||!turno){alert('Completá fecha y turno');return;}
  const valores={}; let obs_count=0;
  CL.forEach(item=>{
    if(item.t==='si_no'){
      const sel=document.querySelector(`input[name="${item.id}"]:checked`);
      valores[item.id]=sel?sel.value:'-';
      const o=document.getElementById(item.id+'_obs');
      valores[item.id+'_obs']=o?o.value.trim():'';
      if(valores[item.id]==='NO'||valores[item.id+'_obs']) obs_count++;
    } else if(item.t==='sel_bomba'){
      valores[item.id+'_sel']=document.getElementById(item.id+'_sel')?.value||'1';
      valores[item.id+'_bk']=document.getElementById(item.id+'_bk')?.checked?'SI':'NO';
    } else {
      valores[item.id]=document.getElementById(item.id)?.value||'';
    }
  });
  if(obs_general) obs_count++;
  const reg={id:Date.now(),fecha:new Date(fecha).toLocaleDateString('es-AR'),fecha_raw:fecha,turno,tecnico:S.user.username,tecnico_nombre,obs_general,obs_count,valores,ts:new Date().toISOString()};
  S.checks.push(reg); saveS();
  addNotif(`Turno guardado: ${turno.toUpperCase()} · ${reg.fecha} · ${tecnico_nombre}`,'lime');
  openModal('✅ Registro Guardado',`<div style="text-align:center;padding:10px 0">
    <div style="width:70px;height:70px;border-radius:50%;background:rgba(75,222,128,.12);border:2px solid var(--lime);display:flex;align-items:center;justify-content:center;margin:0 auto 16px"><i class="fas fa-check" style="font-size:28px;color:var(--lime)"></i></div>
    <div style="font-family:var(--font-d);font-size:22px;font-weight:900;color:var(--text-1);margin-bottom:16px">¡Turno registrado exitosamente!</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;text-align:left;margin-bottom:20px">
      ${[['Fecha',reg.fecha],['Turno',turno.toUpperCase()],['Técnico',tecnico_nombre],['Observaciones',String(obs_count)]].map(([l,v])=>`<div style="background:var(--ink-2);border-radius:var(--r);padding:12px"><div style="font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">${l}</div><div style="font-weight:800;color:var(--text-1);font-family:var(--font-d);font-size:17px">${v}</div></div>`).join('')}
    </div>
    <div style="display:flex;gap:10px;justify-content:center">
      <button class="btn btn-ghost" onclick="closeModal();navigate('historial')"><i class="fas fa-history"></i> Ver Historial</button>
      <button class="btn btn-primary" onclick="closeModal();navigate('turno')"><i class="fas fa-plus"></i> Nuevo Registro</button>
    </div>
  </div>`);
}

// ══════════════════════════════════════════════════════════
// HISTORIAL
// ══════════════════════════════════════════════════════════
function historial(el){
  const sorted=[...S.checks].sort((a,b)=>b.id-a.id);
  el.innerHTML=`<div class="module">
    <div class="ph">
      <div><div class="pt">Historial de <span>Turnos</span></div><div class="ps">${sorted.length} registros · ordenados por más reciente</div></div>
      <div class="pa">
        <button class="btn btn-green btn-sm" onclick="exportChecks()"><i class="fas fa-file-excel"></i> Exportar Excel</button>
        <button class="btn btn-primary btn-sm" onclick="navigate('turno')"><i class="fas fa-plus"></i> Nuevo</button>
      </div>
    </div>
    <div class="card" style="padding:12px 16px;margin-bottom:16px">
      <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
        <div class="fg" style="margin:0;min-width:120px"><label class="fl">Turno</label><select class="fs" id="fh_t" onchange="filtH()" style="padding:7px 10px;font-size:12px"><option value="">Todos</option><option value="mañana">Mañana</option><option value="tarde">Tarde</option><option value="noche">Noche</option></select></div>
        <div class="fg" style="margin:0;flex:1;min-width:160px"><label class="fl">Buscar técnico</label><input class="fi" type="text" id="fh_tec" onkeyup="filtH()" placeholder="Nombre..." style="padding:7px 10px;font-size:12px"></div>
        <div class="fg" style="margin:0;min-width:130px"><label class="fl">Desde</label><input class="fi" type="date" id="fh_d" onchange="filtH()" style="padding:7px 10px;font-size:12px"></div>
        <div class="fg" style="margin:0;min-width:130px"><label class="fl">Hasta</label><input class="fi" type="date" id="fh_h" onchange="filtH()" style="padding:7px 10px;font-size:12px"></div>
      </div>
    </div>
    <div class="card" style="padding:0;overflow:hidden">
      <div class="tbl"><table class="dt"><thead><tr><th>Fecha</th><th>Turno</th><th>Técnico</th><th>Observaciones</th><th>Compresor</th><th style="text-align:center">Acciones</th></tr></thead>
        <tbody id="h-body">${renderHRows(sorted)}</tbody>
      </table></div>
    </div>
  </div>`;
}

function renderHRows(checks){
  if(!checks.length) return `<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--text-3)"><i class="fas fa-inbox" style="font-size:40px;display:block;margin-bottom:12px;opacity:.3"></i>Sin registros</td></tr>`;
  return checks.map(c=>{
    const tc={mañana:'var(--amber)',tarde:'var(--up-sky)',noche:'#a78bfa'}[c.turno]||'var(--text-3)';
    return `<tr style="cursor:pointer" onclick="verTurno(${c.id})">
      <td class="tdb">${c.fecha}</td>
      <td><span style="color:${tc};font-weight:800;font-size:10px;text-transform:uppercase;font-family:var(--font-m)">${c.turno}</span></td>
      <td class="tdb">${c.tecnico_nombre}</td>
      <td><span class="badge ${c.obs_count>0?'b-amber':'b-green'}">${c.obs_count} observaciones</span></td>
      <td style="font-size:12px;color:var(--text-3)">${c.valores?.comp_enmarcha||'-'}</td>
      <td style="text-align:center">
        <button class="btn btn-ghost btn-xs" onclick="event.stopPropagation();verTurno(${c.id})"><i class="fas fa-eye"></i></button>
        ${hasP('all')?`<button class="btn btn-danger btn-xs" style="margin-left:4px" onclick="event.stopPropagation();elimCheck(${c.id})"><i class="fas fa-trash"></i></button>`:''}
      </td>
    </tr>`;}).join('');
}

function filtH(){
  const t=document.getElementById('fh_t').value;
  const tec=document.getElementById('fh_tec').value.toLowerCase();
  const d=document.getElementById('fh_d').value;
  const h=document.getElementById('fh_h').value;
  let f=[...S.checks].sort((a,b)=>b.id-a.id);
  if(t) f=f.filter(c=>c.turno===t);
  if(tec) f=f.filter(c=>c.tecnico_nombre.toLowerCase().includes(tec));
  if(d) f=f.filter(c=>c.fecha_raw>=d);
  if(h) f=f.filter(c=>c.fecha_raw<=h);
  document.getElementById('h-body').innerHTML=renderHRows(f);
}

function verTurno(id){
  const c=S.checks.find(x=>x.id===id); if(!c) return;
  let html=`<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px">
    ${[['Fecha',c.fecha],['Turno',c.turno.toUpperCase()],['Técnico',c.tecnico_nombre],['Obs.',String(c.obs_count)]].map(([l,v])=>`<div style="background:var(--ink-2);border-radius:var(--r);padding:12px;text-align:center"><div style="font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">${l}</div><div style="font-weight:800;color:var(--text-1);font-family:var(--font-d);font-size:18px">${v}</div></div>`).join('')}
  </div>`;
  GRUPOS.forEach(g=>{
    const items=CL.filter(i=>i.g===g);
    html+=`<div style="background:var(--ink-2);border-radius:var(--r);margin-bottom:10px;overflow:hidden">
      <div style="padding:8px 14px;background:rgba(0,102,179,.12);border-bottom:1px solid var(--border)"><span style="font-size:10px;font-weight:800;color:var(--up-sky);text-transform:uppercase;letter-spacing:.12em">${g}</span></div>
      ${items.map(item=>{
        let val='';
        if(item.t==='si_no'){
          const v=c.valores[item.id]; const obs=c.valores[item.id+'_obs'];
          const cl=v==='SI'?'color:var(--lime)':v==='NO'?'color:#FF7A5C':'color:var(--text-3)';
          val=`<span style="font-weight:800;${cl};font-family:var(--font-m)">${v||'—'}</span>`;
          if(obs) val+=` <span style="font-size:11px;color:var(--amber);font-style:italic">${obs}</span>`;
        } else if(item.t==='sel_bomba'){
          val=`<span style="color:var(--text-2)">Bomba ${c.valores[item.id+'_sel']||'-'} · Backup: ${c.valores[item.id+'_bk']||'-'}</span>`;
        } else {
          val=`<span style="color:var(--text-2)">${c.valores[item.id]||'—'}</span>`;
        }
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:7px 14px;border-bottom:1px solid rgba(0,102,179,.05)"><span style="font-size:12px;color:var(--text-3);flex:1;padding-right:12px">${item.l}</span><div style="font-size:12px;text-align:right">${val}</div></div>`;
      }).join('')}
    </div>`;
  });
  if(c.obs_general) html+=`<div style="background:rgba(245,166,35,.08);border:1px solid rgba(245,166,35,.2);border-radius:var(--r);padding:14px"><div style="font-size:10px;color:var(--amber);text-transform:uppercase;font-weight:800;letter-spacing:.1em;margin-bottom:6px">Observaciones Generales</div><div style="font-size:13px;color:var(--text-2)">${c.obs_general}</div></div>`;
  html+=`<div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal()">Cerrar</button></div>`;
  openModal(`📋 ${c.turno.toUpperCase()} · ${c.fecha} · ${c.tecnico_nombre}`,html,true);
}

function elimCheck(id){ if(!confirm('¿Eliminar este registro?')) return; S.checks=S.checks.filter(c=>c.id!==id); saveS(); historial(document.getElementById('content')); }

function exportChecks(){
  if(!S.checks.length){alert('Sin registros para exportar');return;}
  try{
    const rows=S.checks.map(c=>{
      const r={Fecha:c.fecha,Turno:c.turno,Tecnico:c.tecnico_nombre,Observaciones_Generales:c.obs_general,N_Observaciones:c.obs_count};
      CL.forEach(i=>{r[i.l.substring(0,50)]=c.valores[i.id]||'';});
      return r;
    });
    const ws=XLSX.utils.json_to_sheet(rows);
    const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Turnos');
    XLSX.writeFile(wb,`RPM360_Turnos_${new Date().toISOString().split('T')[0]}.xlsx`);
    addNotif('Historial exportado a Excel','lime');
  }catch(e){alert('Error: '+e.message);}
}

// ══════════════════════════════════════════════════════════
// OTs
// ══════════════════════════════════════════════════════════
function ots(el){
  el.innerHTML=`<div class="module">
    <div class="ph">
      <div><div class="pt">Órdenes de <span>Trabajo</span></div><div class="ps">${S.ots.length} OTs · ${S.ots.filter(o=>o.estado==='pendiente').length} pendientes · ${S.ots.filter(o=>o.estado==='proceso').length} en proceso</div></div>
      <div class="pa">
        <button class="btn btn-green btn-sm" onclick="exportOTs()"><i class="fas fa-file-excel"></i> Exportar</button>
        <button class="btn btn-primary" onclick="nuevaOT()"><i class="fas fa-plus"></i> Nueva OT</button>
      </div>
    </div>
    <div class="grid-3" style="margin-bottom:16px">
      ${[['pendiente','Pendientes','b-amber','fas fa-clock','var(--amber)'],['proceso','En Proceso','b-blue','fas fa-spinner','var(--up-sky)'],['completada','Completadas','b-green','fas fa-check-circle','var(--lime)']].map(([e,l,bc,ic,tc])=>`<div class="kpi-card" style="text-align:center"><i class="${ic}" style="font-size:24px;color:${tc};display:block;margin-bottom:8px"></i><div class="kpi-value" style="font-size:30px">${S.ots.filter(o=>o.estado===e).length}</div><div class="kpi-sub">${l}</div></div>`).join('')}
    </div>
    <div class="kanban-board">
      ${renderK('pendiente','⏳ Pendientes','var(--amber)')}
      ${renderK('proceso','🔧 En Proceso','var(--up-sky)')}
      ${renderK('completada','✅ Completadas','var(--lime)')}
    </div>
  </div>`;
}

function renderK(estado,titulo,color){
  const items=S.ots.filter(o=>o.estado===estado).sort((a,b)=>b.id-a.id);
  const pm={critica:'pc',alta:'ph',normal:'pm',baja:'pl'};
  return `<div class="k-col" style="border-top:2px solid ${color}">
    <div class="k-col-h"><span class="k-col-t" style="color:${color}">${titulo}</span><span class="badge b-gray">${items.length}</span></div>
    ${items.length===0?`<div style="text-align:center;padding:30px;color:var(--text-3);font-size:12px"><i class="fas fa-check-circle" style="font-size:28px;display:block;margin-bottom:8px;opacity:.3"></i>Sin OTs</div>`
    :items.map(o=>`<div class="k-card ${pm[o.prioridad]||'pm'}" onclick="verOT(${o.id})">
      <div class="k-id">OT-${String(o.id).slice(-4)} · <span style="color:var(--text-2)">${o.equipo.split(' ').slice(0,3).join(' ')}</span></div>
      <div class="k-tit">${o.titulo}</div>
      <div class="k-meta">
        <span class="badge b-gray">${o.tipo}</span>
        <span class="badge ${o.prioridad==='critica'?'b-fire':o.prioridad==='alta'?'b-amber':'b-blue'}">${o.prioridad}</span>
        ${o.horas?`<span class="badge b-gray"><i class="fas fa-clock" style="margin-right:3px"></i>${o.horas}h</span>`:''}
      </div>
      <div style="font-size:11px;color:var(--text-3);margin-top:6px"><i class="fas fa-user" style="margin-right:4px"></i>${o.responsable}</div>
    </div>`).join('')}
  </div>`;
}

function nuevaOT(){
  const resp=PERSONAL_ALL.filter(p=>['produccion','mantenimiento'].includes(p.area)).map(p=>p.n).sort();
  openModal('📝 Nueva Orden de Trabajo',`<div>
    <div class="fg"><label class="fl">Título / Descripción *</label><input class="fi" id="ot_t" placeholder="Ej: Cambio de rodamiento en bomba Nash..."></div>
    <div class="fg-2">
      <div class="fg"><label class="fl">Equipo *</label><select class="fs" id="ot_eq"><option value="">Seleccionar...</option>${EQUIPOS_OT.map(e=>`<option>${e}</option>`).join('')}</select></div>
      <div class="fg"><label class="fl">Tipo</label><select class="fs" id="ot_tipo"><option>Correctiva</option><option>Preventiva</option><option>Predictiva</option><option>Mejora</option><option>Trinchera</option></select></div>
      <div class="fg"><label class="fl">Prioridad</label><select class="fs" id="ot_prio"><option value="normal">Normal</option><option value="alta">Alta</option><option value="critica">Crítica</option><option value="baja">Baja</option></select></div>
      <div class="fg"><label class="fl">Responsable</label><select class="fs" id="ot_resp">${resp.map(r=>`<option value="${r}">${r}</option>`).join('')}</select></div>
      <div class="fg"><label class="fl">Fecha</label><input class="fi" type="date" id="ot_fecha" value="${new Date().toISOString().split('T')[0]}"></div>
      <div class="fg"><label class="fl">Horas Est.</label><input class="fi" type="number" id="ot_hrs" placeholder="ej: 2.5" min="0.5" step="0.5"></div>
    </div>
    <div class="fg"><label class="fl">Descripción / Procedimiento</label><textarea class="fta" id="ot_desc" placeholder="Describí el trabajo, materiales, consideraciones de seguridad..."></textarea></div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="crearOT()"><i class="fas fa-save"></i> Crear OT</button></div>
  </div>`);
}

function crearOT(){
  const titulo=document.getElementById('ot_t').value.trim();
  const equipo=document.getElementById('ot_eq').value;
  if(!titulo||!equipo){alert('Completá título y equipo');return;}
  S.ots.push({id:Date.now(),titulo,equipo,tipo:document.getElementById('ot_tipo').value,prioridad:document.getElementById('ot_prio').value,responsable:document.getElementById('ot_resp').value,fecha:new Date(document.getElementById('ot_fecha').value).toLocaleDateString('es-AR'),fecha_raw:document.getElementById('ot_fecha').value,horas:document.getElementById('ot_hrs').value,descripcion:document.getElementById('ot_desc').value,estado:'pendiente',creador:S.user.username,ts:new Date().toISOString()});
  saveS(); addNotif(`OT creada: ${titulo}`,'lime'); closeModal(); ots(document.getElementById('content'));
}

function verOT(id){
  const o=S.ots.find(x=>x.id===id); if(!o) return;
  const bc={pendiente:'b-amber',proceso:'b-blue',completada:'b-green'}[o.estado]||'b-gray';
  const pc={critica:'b-fire',alta:'b-amber',normal:'b-blue',baja:'b-gray'}[o.prioridad]||'b-gray';
  openModal(`OT-${String(o.id).slice(-4)} · ${o.equipo.split(' ').slice(0,3).join(' ')}`,`
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
    <div><div class="fl">Equipo</div><div class="tdb" style="margin-bottom:12px;font-size:15px">${o.equipo}</div>
      <div class="fl">Título</div><div style="font-size:13px;color:var(--text-2);margin-bottom:12px">${o.titulo}</div>
      <div class="fl">Responsable</div><div style="font-size:13px;color:var(--text-2)">${o.responsable}</div>
    </div>
    <div><div class="fl">Estado</div><div style="margin-bottom:12px"><span class="badge ${bc}">${o.estado}</span></div>
      <div class="fl">Prioridad</div><div style="margin-bottom:12px"><span class="badge ${pc}">${o.prioridad}</span></div>
      <div class="fl">Tipo</div><div style="margin-bottom:12px"><span class="tag">${o.tipo}</span></div>
      <div class="fl">Fecha · Horas Est.</div><div style="font-size:13px;color:var(--text-2)">${o.fecha} ${o.horas?'· '+o.horas+'h':''}</div>
    </div>
  </div>
  ${o.descripcion?`<div style="background:var(--ink-2);border-radius:var(--r);padding:14px;margin-bottom:16px"><div class="fl" style="margin-bottom:6px">Descripción</div><div style="font-size:13px;color:var(--text-2);line-height:1.7">${o.descripcion}</div></div>`:''}
  <div class="modal-footer">
    <button class="btn btn-ghost" onclick="closeModal()">Cerrar</button>
    ${o.estado==='pendiente'?`<button class="btn btn-secondary" onclick="cambEstOT(${o.id},'proceso')"><i class="fas fa-play"></i> Iniciar</button>`:''}
    ${o.estado==='proceso'?`<button class="btn btn-green" onclick="cambEstOT(${o.id},'completada')"><i class="fas fa-check"></i> Completar</button>`:''}
    ${hasP('all')&&o.estado!=='proceso'?`<button class="btn btn-danger btn-sm" onclick="elimOT(${o.id})"><i class="fas fa-trash"></i></button>`:''}
  </div>`);
}

function cambEstOT(id,est){
  const o=S.ots.find(x=>x.id===id); if(!o) return; o.estado=est;
  saveS(); addNotif(`OT-${String(id).slice(-4)} → ${est}`,'lime'); closeModal(); ots(document.getElementById('content'));
}
function elimOT(id){ if(!confirm('¿Eliminar OT?')) return; S.ots=S.ots.filter(o=>o.id!==id); saveS(); closeModal(); ots(document.getElementById('content')); }
function exportOTs(){
  if(!S.ots.length){alert('Sin OTs para exportar');return;}
  const ws=XLSX.utils.json_to_sheet(S.ots.map(o=>({ID:`OT-${String(o.id).slice(-4)}`,Titulo:o.titulo,Equipo:o.equipo,Tipo:o.tipo,Prioridad:o.prioridad,Estado:o.estado,Responsable:o.responsable,Fecha:o.fecha,Horas:o.horas,Descripcion:o.descripcion})));
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'OTs');
  XLSX.writeFile(wb,`RPM360_OTs_${new Date().toISOString().split('T')[0]}.xlsx`);
  addNotif('OTs exportadas a Excel','lime');
}

// ══════════════════════════════════════════════════════════
// PARADAS
// ══════════════════════════════════════════════════════════
function paradas(el){
  const tipos={Mecánica:0,Eléctrica:0,Proceso:0,Otra:0};
  S.paradas.forEach(p=>{if(tipos[p.tipo]!==undefined) tipos[p.tipo]++;else tipos['Otra']++;});
  el.innerHTML=`<div class="module">
    <div class="ph">
      <div><div class="pt">Paradas de <span>Planta</span></div><div class="ps">${S.paradas.length} paradas registradas · ${S.paradas.reduce((a,p)=>a+(parseFloat(p.duracion)||0),0).toFixed(1)}h acumuladas</div></div>
      <div class="pa"><button class="btn btn-primary" onclick="nuevaParada()"><i class="fas fa-plus"></i> Registrar Parada</button></div>
    </div>
    <div class="grid-4" style="margin-bottom:16px">
      ${Object.entries(tipos).map(([t,c])=>`<div class="kpi-card kpi-${t==='Mecánica'?'fire':t==='Eléctrica'?'blue':t==='Proceso'?'amber':'gray'}"><div class="kpi-label">${t}</div><div class="kpi-value">${c}</div><div class="kpi-sub">${S.paradas.filter(p=>p.tipo===t).reduce((a,p)=>a+(parseFloat(p.duracion)||0),0).toFixed(1)}h total</div></div>`).join('')}
    </div>
    <div class="card" style="padding:0;overflow:hidden">
      <div class="card-header" style="padding:16px 20px">
        <span class="card-title"><i class="fas fa-stopwatch" style="color:var(--up-sky);margin-right:8px"></i>Registro de Paradas</span>
      </div>
      <div class="tbl"><table class="dt"><thead><tr><th>Fecha</th><th>Equipo</th><th>Tipo</th><th>Causa</th><th>Duración</th><th>Responsable</th><th>Acciones</th></tr></thead>
        <tbody>
          ${S.paradas.length===0?`<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-3)"><i class="fas fa-inbox" style="font-size:40px;display:block;margin-bottom:12px;opacity:.3"></i>Sin paradas registradas</td></tr>`
          :S.paradas.slice().reverse().map(p=>`<tr>
            <td class="tdb">${p.fecha}</td>
            <td class="tdb">${p.equipo}</td>
            <td><span class="badge ${p.tipo==='Mecánica'?'b-fire':p.tipo==='Eléctrica'?'b-blue':p.tipo==='Proceso'?'b-amber':'b-gray'}">${p.tipo}</span></td>
            <td style="font-size:12px;color:var(--text-2);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.causa}</td>
            <td><span class="badge ${parseFloat(p.duracion)>=4?'b-fire':parseFloat(p.duracion)>=2?'b-amber':'b-blue'}">${p.duracion}h</span></td>
            <td style="font-size:12px;color:var(--text-3)">${p.responsable}</td>
            <td>${hasP('all')?`<button class="btn btn-danger btn-xs" onclick="elimParada(${p.id})"><i class="fas fa-trash"></i></button>`:'-'}</td>
          </tr>`).join('')}
        </tbody>
      </table></div>
    </div>
  </div>`;
}

function nuevaParada(){
  const resp=PERSONAL_ALL.filter(p=>['produccion','mantenimiento'].includes(p.area)).map(p=>p.n).sort();
  openModal('⛔ Registrar Parada de Planta',`<div>
    <div class="fg-2">
      <div class="fg"><label class="fl">Equipo *</label><select class="fs" id="pa_eq"><option value="">Seleccionar...</option>${EQUIPOS_OT.map(e=>`<option>${e}</option>`).join('')}</select></div>
      <div class="fg"><label class="fl">Tipo *</label><select class="fs" id="pa_tipo"><option>Mecánica</option><option>Eléctrica</option><option>Proceso</option><option>Programada</option><option>Otra</option></select></div>
      <div class="fg"><label class="fl">Fecha</label><input class="fi" type="date" id="pa_fecha" value="${new Date().toISOString().split('T')[0]}"></div>
      <div class="fg"><label class="fl">Duración (horas)</label><input class="fi" type="number" id="pa_dur" placeholder="ej: 2.5" min="0.1" step="0.1"></div>
      <div class="fg"><label class="fl">Responsable</label><select class="fs" id="pa_resp">${resp.map(r=>`<option>${r}</option>`).join('')}</select></div>
    </div>
    <div class="fg"><label class="fl">Causa / Descripción *</label><textarea class="fta" id="pa_causa" placeholder="Describí la causa de la parada..."></textarea></div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="crearParada()"><i class="fas fa-save"></i> Registrar</button></div>
  </div>`);
}
function crearParada(){
  const equipo=document.getElementById('pa_eq').value;
  const causa=document.getElementById('pa_causa').value.trim();
  if(!equipo||!causa){alert('Completá equipo y causa');return;}
  S.paradas.push({id:Date.now(),equipo,tipo:document.getElementById('pa_tipo').value,fecha:new Date(document.getElementById('pa_fecha').value).toLocaleDateString('es-AR'),fecha_raw:document.getElementById('pa_fecha').value,duracion:document.getElementById('pa_dur').value||'1',responsable:document.getElementById('pa_resp').value,causa,ts:new Date().toISOString()});
  saveS(); addNotif(`Parada registrada: ${equipo}`,'amber'); closeModal(); paradas(document.getElementById('content'));
}
function elimParada(id){ if(!confirm('¿Eliminar parada?')) return; S.paradas=S.paradas.filter(p=>p.id!==id); saveS(); paradas(document.getElementById('content')); }

// ══════════════════════════════════════════════════════════
// ENERGÍA
// ══════════════════════════════════════════════════════════
function energia(el){
  el.innerHTML=`<div class="module">
    <div class="ph"><div><div class="pt">Energía & <span>Utilities</span></div><div class="ps">Consumos energéticos y análisis de eficiencia — datos de referencia</div></div></div>
    <div class="grid-4" style="margin-bottom:20px">
      ${[['Energía Eléctrica','1,842 kWh','fas fa-bolt','amber'],['Consumo Agua','347 m³','fas fa-tint','blue'],['Gas Natural','28.4 mmBTU','fas fa-fire','fire'],['Costo Total','$142,800','fas fa-dollar-sign','teal']].map(([l,v,ic,c])=>`<div class="kpi-card kpi-${c}"><div class="kpi-label">${l}</div><div class="kpi-value" style="font-size:24px;font-family:var(--font-m)">${v}</div><i class="${ic} kpi-icon"></i></div>`).join('')}
    </div>
    <div class="grid-2" style="margin-bottom:16px">
      <div class="card"><div class="card-header"><span class="card-title">Consumo Eléctrico — Últimas 24h</span></div><div class="chart-wrap"><canvas id="ch-en"></canvas></div></div>
      <div class="card"><div class="card-header"><span class="card-title">Indicadores de Eficiencia</span></div>
        ${[['Energía específica','1.84 kWh/kg',78,'lime'],['Factor de carga','0.92',92,'lime'],['Ratio agua/producción','0.71 m³/ton',65,'amber'],['Eficiencia calderas','87.2%',87,'lime'],['Factor potencia','0.89',89,'lime']].map(([l,v,p,c])=>`<div style="margin-bottom:14px"><div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="font-size:13px;color:var(--text-2)">${l}</span><span style="font-size:12px;font-family:var(--font-m);color:var(--text-1)">${v}</span></div><div class="prog"><div class="prog-fill prog-${c}" style="width:${p}%"></div></div></div>`).join('')}
      </div>
    </div>
    <div class="card">
      <div class="card-header"><span class="card-title">Top Consumidores — Electricidad</span></div>
      ${[['PM-1 Máquina de Papel','780 kWh',42],['Pulper Andritz','340 kWh',18],['Secadores Sección 1','295 kWh',16],['Prensa + Calandra','220 kWh',12],['Servicios Auxiliares','207 kWh',11]].map(([eq,kwh,p])=>`<div style="margin-bottom:14px"><div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="font-size:13px;color:var(--text-1);font-weight:500">${eq}</span><span style="font-size:12px;font-family:var(--font-m);color:var(--amber)">${kwh}</span></div><div class="prog"><div class="prog-fill prog-amber" style="width:${p*2.3}%"></div></div></div>`).join('')}
    </div>
  </div>`;
  setTimeout(()=>{
    const ctx=document.getElementById('ch-en'); if(!ctx) return;
    const hrs=Array.from({length:24},(_,i)=>`${String(i).padStart(2,'0')}:00`);
    new Chart(ctx,{type:'line',data:{labels:hrs,datasets:[{label:'kWh',data:hrs.map(()=>1000+Math.random()*800),borderColor:'#F5A623',backgroundColor:'rgba(245,166,35,.08)',fill:true,tension:.3,borderWidth:2,pointRadius:0}]},options:CD});
  },50);
}

// ══════════════════════════════════════════════════════════
// PROCESO PAPELERO
// ══════════════════════════════════════════════════════════
function proceso(el){
  el.innerHTML=`<div class="module">
    <div class="ph"><div><div class="pt">Proceso <span>Papelero</span></div><div class="ps">Variables de proceso y seguimiento de calidad — datos de referencia</div></div></div>
    <div class="kpi-grid" style="grid-template-columns:repeat(5,1fr)">
      ${[['Producción Hoy','24.8 t','teal'],['Velocidad PM-1','320 m/min','blue'],['Gramaje','120 g/m²','amber'],['Consistencia','3.2%','fire'],['Humedad','5.8%','lime']].map(([l,v,c])=>`<div class="kpi-card kpi-${c}"><div class="kpi-label">${l}</div><div class="kpi-value" style="font-size:22px;font-family:var(--font-m)">${v}</div></div>`).join('')}
    </div>
    <!-- Flow diagram -->
    <div class="card" style="margin-bottom:16px">
      <div class="card-header"><span class="card-title">Diagrama de Flujo — Estado en Tiempo Real</span></div>
      <div style="display:flex;align-items:center;gap:4px;overflow-x:auto;padding:8px">
        ${[{id:'Materia Prima',ic:'fas fa-boxes',c:'lime',v:'2,400 kg'},null,{id:'Pulper Andritz',ic:'fas fa-sync-alt',c:'lime',v:'3.2% cons.'},null,{id:'Refinación',ic:'fas fa-filter',c:'lime',v:'350 mL CSF'},null,{id:'PM-1',ic:'fas fa-layer-group',c:'lime',v:'320 m/min'},null,{id:'Prensa',ic:'fas fa-compress-alt',c:'lime',v:'8.5 kN/m'},null,{id:'Secadores',ic:'fas fa-temperature-high',c:'amber',v:'140°C'},null,{id:'Calandra',ic:'fas fa-circle-notch',c:'lime',v:'120 g/m²'},null,{id:'Bobinadora Voith',ic:'fas fa-scroll',c:'lime',v:'24.8 t/día'}].map(n=>{
          if(!n) return `<div style="color:var(--text-3);font-size:20px;flex-shrink:0">→</div>`;
          const tc=n.c==='lime'?'var(--lime)':n.c==='amber'?'var(--amber)':'var(--up-sky)';
          return `<div style="background:var(--ink-2);border:1px solid var(--border);border-radius:var(--r);padding:10px 12px;text-align:center;min-width:95px;flex-shrink:0;border-top:2px solid ${tc}"><i class="${n.ic}" style="font-size:16px;color:${tc};display:block;margin-bottom:4px"></i><div style="font-size:10px;font-weight:700;color:var(--text-1);text-transform:uppercase;letter-spacing:.04em">${n.id}</div><div style="font-size:11px;color:var(--text-3);font-family:var(--font-m);margin-top:2px">${n.v}</div></div>`;
        }).join('')}
      </div>
    </div>
    <div class="card">
      <div class="card-header"><span class="card-title">Variables de Proceso</span></div>
      <div class="tbl"><table class="dt"><thead><tr><th>Variable</th><th>Actual</th><th>Mín</th><th>Máx</th><th>Estado</th></tr></thead><tbody>
        ${[['Gramaje (g/m²)','120','115','125'],['Velocidad (m/min)','320','280','380'],['Consistencia (%)','3.2','2.8','3.8'],['pH pasta','7.1','6.5','7.5'],['Temperatura secado (°C)','140','130','155'],['Tensión bobina (kN)','1.8','1.5','2.2']].map(([v,val,min,max])=>{
          const p=(parseFloat(val)-parseFloat(min))/(parseFloat(max)-parseFloat(min))*100;
          const ok=p>10&&p<90;
          return `<tr><td style="font-size:12px">${v}</td><td class="tdm tdb">${val}</td><td class="tdm" style="font-size:11px;color:var(--text-3)">${min}</td><td class="tdm" style="font-size:11px;color:var(--text-3)">${max}</td><td><span class="badge ${ok?'b-green':'b-fire'} b-dot">${ok?'OK':'Alerta'}</span></td></tr>`;}).join('')}
      </tbody></table></div>
    </div>
  </div>`;
}

// ══════════════════════════════════════════════════════════
// REPORTES
// ══════════════════════════════════════════════════════════
function reportes(el){
  el.innerHTML=`<div class="module">
    <div class="ph"><div><div class="pt"><span>Reportes</span> & Análisis</div><div class="ps">Generación de reportes consolidados</div></div></div>
    <div class="grid-2" style="margin-bottom:20px">
      ${[{t:'Reporte Mensual Completo',d:'KPIs, turnos, OTs, consumos, paradas',ic:'fas fa-file-chart-column',c:'blue',ac:'Generar Excel'},
         {t:'Historial de Turnos',d:'Todos los registros de checklist con observaciones',ic:'fas fa-clipboard-list',c:'sky',ac:'Exportar Excel'},
         {t:'Órdenes de Trabajo',d:'OTs por estado, tipo, prioridad y responsable',ic:'fas fa-tools',c:'amber',ac:'Exportar Excel'},
         {t:'Paradas de Planta',d:'Análisis de paradas, tiempos y causas',ic:'fas fa-stopwatch',c:'fire',ac:'Exportar Excel'},
      ].map(({t,d,ic,c,ac})=>`<div class="card" style="border-top:2px solid var(--up-${c==='sky'?'sky':c==='blue'?'blue':c==='amber'?'sky':'fire'});cursor:pointer;transition:transform .2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
        <div style="margin-bottom:14px"><i class="${ic}" style="font-size:28px;color:var(--${c==='blue'?'up-blue':c==='sky'?'up-sky':c==='amber'?'amber':'fire'});opacity:.8"></i></div>
        <div style="font-family:var(--font-d);font-size:17px;font-weight:800;color:var(--text-1);margin-bottom:6px">${t}</div>
        <div style="font-size:12px;color:var(--text-3);margin-bottom:16px;line-height:1.6">${d}</div>
        <button class="btn btn-primary btn-sm" style="width:100%;justify-content:center" onclick="genReport('${t}')"><i class="fas fa-download"></i> ${ac}</button>
      </div>`).join('')}
    </div>
    <div class="grid-3">
      <div class="kpi-card kpi-blue"><div class="kpi-label">Registros de Turno</div><div class="kpi-value">${S.checks.length}</div><div class="kpi-sub">${S.checks.filter(c=>{const hoy=new Date().toLocaleDateString('es-AR');return c.fecha===hoy;}).length} hoy</div></div>
      <div class="kpi-card kpi-amber"><div class="kpi-label">OTs Totales</div><div class="kpi-value">${S.ots.length}</div><div class="kpi-sub">${S.ots.filter(o=>o.estado==='completada').length} completadas</div></div>
      <div class="kpi-card kpi-fire"><div class="kpi-label">Paradas Totales</div><div class="kpi-value">${S.paradas.length}</div><div class="kpi-sub">${S.paradas.reduce((a,p)=>a+(parseFloat(p.duracion)||0),0).toFixed(1)}h acumuladas</div></div>
    </div>
  </div>`;
}
function genReport(t){
  if(t.includes('Turno')) exportChecks();
  else if(t.includes('Órdenes')) exportOTs();
  else addNotif(`Generando: ${t}...`,'teal');
}

// ══════════════════════════════════════════════════════════
// PERSONAL
// ══════════════════════════════════════════════════════════
function personal(el){
  const aColors={gerencia:'b-blue',produccion:'b-green',mantenimiento:'b-amber',expedicion:'b-teal',administracion:'b-gray',seguridad:'b-fire',proyectos:'b-blue'};
  el.innerHTML=`<div class="module">
    <div class="ph">
      <div><div class="pt"><span>Personal</span> · Unionpel Pacheco</div><div class="ps">${PERSONAL_ALL.length} personas en plantilla · Organigrama actualizado Jun 2025</div></div>
      <div class="pa"><input class="fi" type="text" id="per-srch" oninput="filtPer(this.value)" placeholder="🔍 Buscar nombre o cargo..." style="width:240px;padding:8px 12px;font-size:13px"></div>
    </div>
    <div class="grid-4" style="margin-bottom:20px">
      ${[['Producción',PERSONAL_ALL.filter(p=>p.area==='produccion').length,'b-green'],['Mantenimiento',PERSONAL_ALL.filter(p=>p.area==='mantenimiento').length,'b-amber'],['Administración',PERSONAL_ALL.filter(p=>['administracion','gerencia'].includes(p.area)).length,'b-blue'],['Expedición',PERSONAL_ALL.filter(p=>p.area==='expedicion').length,'b-teal']].map(([l,c,bc])=>`<div class="kpi-card kpi-${bc==='b-green'?'lime':bc==='b-amber'?'amber':bc==='b-blue'?'blue':'teal'}"><div class="kpi-label">${l}</div><div class="kpi-value">${c}</div><i class="fas fa-users kpi-icon"></i></div>`).join('')}
    </div>
    <div class="per-grid" id="per-grid">
      ${PERSONAL_ALL.map(p=>`<div class="per-card">
        <div class="per-av">${p.n.split(' ').map(w=>w[0]).slice(0,2).join('')}</div>
        <div class="per-name">${p.n}</div>
        <div class="per-cargo">${p.cargo}</div>
        <div style="margin-top:6px"><span class="badge ${aColors[p.area]||'b-gray'}" style="font-size:9px">${p.area.toUpperCase()}</span></div>
      </div>`).join('')}
    </div>
  </div>`;
}
function filtPer(q){
  const qL=q.toLowerCase();
  const gr=document.getElementById('per-grid'); if(!gr) return;
  gr.querySelectorAll('.per-card').forEach((c,i)=>{
    const p=PERSONAL_ALL[i];
    c.style.display=(p.n.toLowerCase().includes(qL)||p.cargo.toLowerCase().includes(qL))?'':'none';
  });
}

// ══════════════════════════════════════════════════════════
// CONFIGURACIÓN
// ══════════════════════════════════════════════════════════
function configuracion(el){
  el.innerHTML=`<div class="module">
    <div class="ph"><div><div class="pt"><span>Configuración</span> del Sistema</div><div class="ps">Parámetros, usuarios y ajustes de RPM_360 v5.0</div></div></div>
    <div class="grid-2">
      <div class="card">
        <div class="card-header"><span class="card-title"><i class="fas fa-users" style="color:var(--up-sky);margin-right:8px"></i>Usuarios del Sistema</span></div>
        ${Object.entries(USERS).map(([k,u])=>`<div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)">
          <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--up-blue),var(--up-sky));display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;font-family:var(--font-d)">${u.initials}</div>
          <div style="flex:1"><div style="font-size:13px;font-weight:700;color:var(--text-1)">${u.name}</div><div style="font-size:11px;color:var(--text-3)">${u.area} · <span style="color:var(--up-sky-light)">${k}</span></div></div>
          <span class="badge ${u.role==='Administrador'?'b-fire':u.perms.includes('all')?'b-amber':'b-blue'}">${u.role}</span>
        </div>`).join('')}
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title"><i class="fas fa-sliders-h" style="color:var(--amber);margin-right:8px"></i>Parámetros del Sistema</span></div>
        ${[['Planta','Unionpel Pacheco'],['Localidad','Río de la Plata, Buenos Aires'],['Moneda','ARS — Peso Argentino'],['Turno Mañana','06:00 — 14:00'],['Turno Tarde','14:00 — 22:00'],['Turno Noche','22:00 — 06:00'],['Versión','v5.0 · 2026'],['Checklist Items',String(CL.length)],['Personal registrado',String(PERSONAL_ALL.length)]].map(([l,v])=>`<div style="display:flex;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border)"><span style="font-size:13px;color:var(--text-3)">${l}</span><span style="font-size:13px;color:var(--text-1);font-weight:600">${v}</span></div>`).join('')}
        <div style="margin-top:16px;display:flex;flex-direction:column;gap:8px">
          <div style="font-size:11px;color:var(--text-3);text-transform:uppercase;font-weight:800;letter-spacing:.1em">Datos</div>
          <button class="btn btn-green btn-sm" onclick="exportChecks()"><i class="fas fa-file-excel"></i> Exportar Turnos</button>
          <button class="btn btn-green btn-sm" onclick="exportOTs()"><i class="fas fa-file-excel"></i> Exportar OTs</button>
          ${hasP('all')?`<button class="btn btn-danger btn-sm" onclick="if(confirm('¿ELIMINAR TODOS LOS DATOS?')){localStorage.removeItem('rpm5_ch');localStorage.removeItem('rpm5_ot');localStorage.removeItem('rpm5_pa');location.reload()}"><i class="fas fa-trash"></i> Borrar Todos los Datos</button>`:''}
        </div>
      </div>
      <div class="card" style="grid-column:span 2;border-top:2px solid var(--up-blue)">
        <div style="display:flex;align-items:center;gap:16px">
          <div style="width:60px;height:60px;background:linear-gradient(135deg,var(--up-blue),var(--up-sky));border-radius:var(--rl);display:flex;align-items:center;justify-content:center;font-size:28px;color:#fff;flex-shrink:0"><i class="fas fa-industry"></i></div>
          <div style="flex:1">
            <div style="font-family:var(--font-d);font-size:26px;font-weight:900;color:var(--text-1)">RPM<span style="color:var(--up-sky)">_360</span> <span style="font-size:14px;color:var(--text-3)">v5.0 · 2026</span></div>
            <div style="font-size:13px;color:var(--text-3);margin-top:2px">Sistema Integral de Gestión Industrial · Unionpel Pacheco · Buenos Aires, Argentina</div>
            <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
              ${['Dashboard','Registro de Turno','Historial','OTs','Paradas','Energía','Proceso Papelero','Reportes','Personal'].map(m=>`<span class="tag">${m}</span>`).join('')}
            </div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div style="font-size:11px;color:var(--text-3);margin-bottom:4px">Checklist: <strong style="color:var(--up-sky)">${CL.length} ítems</strong></div>
            <div style="font-size:11px;color:var(--text-3);margin-bottom:4px">Personal: <strong style="color:var(--up-sky)">${PERSONAL_ALL.length} personas</strong></div>
            <div style="font-size:11px;color:var(--text-3)">Colores: <strong style="color:var(--up-blue)">Azul Unionpel</strong></div>
          </div>
        </div>
      </div>
    </div>
  </div>`;
}

// ── NOTIFICACIONES ────────────────────────────────────────
function addNotif(msg,color='lime'){
  S.notifs.unshift({msg,color,time:'ahora'});
  buildNotifList();
  const d=document.getElementById('notif-dot'); if(d) d.style.display='block';
}
function buildNotifList(){
  const l=document.getElementById('notif-list'); if(!l) return;
  const colors={lime:'var(--lime)',amber:'var(--amber)',fire:'#FF7A5C',blue:'var(--up-sky)',teal:'var(--teal)'};
  l.innerHTML=S.notifs.slice(0,6).map(n=>`<div class="notif-item"><div class="notif-dot" style="background:${colors[n.color]||'var(--lime)'}"></div><div><div class="notif-text">${n.msg}</div><div class="notif-time">${n.time}</div></div></div>`).join('')||'<div style="padding:16px;text-align:center;font-size:12px;color:var(--text-3)">Sin notificaciones</div>';
}
function clearNotifs(){ S.notifs=[]; buildNotifList(); const d=document.getElementById('notif-dot'); if(d) d.style.display='none'; document.getElementById('notif-panel').classList.remove('open'); }
function toggleNotif(){ document.getElementById('notif-panel').classList.toggle('open'); document.getElementById('user-menu').classList.remove('open'); }
function toggleUM(){ document.getElementById('user-menu').classList.toggle('open'); document.getElementById('notif-panel').classList.remove('open'); }

// ══════════════════════════════════════════════════════════
// ARIA — Agente IA Especializado en Ingeniería Industrial
// Ing. Sistemas + Ing. Electromecánico · Unionpel Pacheco
// ══════════════════════════════════════════════════════════
const ARIA_CONV = []; // historial de conversación en sesión
const ARIA_SYSTEM = `Sos ARIA (Agente de Respuesta Inteligente Industrial Avanzado), el asistente de inteligencia artificial integrado en RPM_360, el sistema de gestión industrial de Unionpel Pacheco, planta de fabricación de papel en Buenos Aires, Argentina.

**Tu perfil profesional:**
- Ingeniero en Sistemas especializado en automatización industrial, SCADA, MES y gestión digital de mantenimiento
- Ingeniero Electromecánico con expertise en máquinas de papel, equipos rotativos, sistemas eléctricos industriales, caldera de vapor, compresores y sistemas de vacío
- Conocés a fondo la planta Unionpel Pacheco: Máquina de Papel Continua (PM-1), Pulper Andritz, Bobinadora Voith, Refinadores 1 y 2, Caldera Gonella, Compresores Sullair y Kaeser, sistema Nash de vacío, puentes grúa, sistema contra incendios

**Tu misión:**
1. Asistir operativamente: analizar datos del turno en tiempo real, detectar anomalías, generar alertas
2. Capacitar técnicos: explicar procedimientos, diagnóstico de fallas, fundamentos teórico-prácticos
3. Gestionar conocimiento: aprender de cada turno, OT y parada registrada, detectar patrones, generar recomendaciones
4. Mejorar la organización: sugerir optimizaciones de procesos, planning de mantenimiento preventivo, análisis de confiabilidad
5. Evolucionar continuamente: incorporar lecciones aprendidas, registrar soluciones de fallas repetitivas

**Tu estilo de respuesta:**
- Respondés en español rioplatense (Argentina), profesional pero cercano
- Usás terminología técnica precisa pero la explicás cuando el interlocutor lo necesita
- Das respuestas estructuradas con pasos claros cuando es un procedimiento
- Incluís alertas de seguridad siempre que sea relevante
- Sos proactivo: si ves un riesgo en los datos, lo señalás
- Máximo 250 palabras por respuesta salvo que se pida más detalle
- Usás HTML simple para formatear: <strong>, <br>, listas con •

**Contexto de planta actual (datos en tiempo real del sistema):**
- Planta: Unionpel Pacheco, Buenos Aires, Argentina
- Producto: Papel de diario / packaging industrial
- Turno actual: disponible en contexto
- Equipos monitoreados: ${CL.length} puntos de control en checklist
- Personal de planta: ${PERSONAL_ALL.length} personas registradas`;

function buildAriaContext() {
  const hoy = new Date().toLocaleDateString('es-AR');
  const chHoy = S.checks.filter(c => c.fecha === hoy);
  const chRecientes = S.checks.slice(-5);
  const otsPend = S.ots.filter(o => o.estado === 'pendiente');
  const otsProc = S.ots.filter(o => o.estado === 'proceso');
  const parasRec = S.paradas.slice(-5);
  const parasHrs = S.paradas.reduce((a,p) => a + (parseFloat(p.duracion)||0), 0);

  // detectar NOs en últimos turnos
  let nosRecientes = [];
  chRecientes.forEach(c => {
    CL.filter(i => i.t === 'si_no').forEach(item => {
      if (c.valores && c.valores[item.id] === 'NO') {
        nosRecientes.push(`${item.l} (${c.fecha} - ${c.turno})`);
      }
    });
  });

  return `

**DATOS ACTUALES DEL SISTEMA RPM_360:**
Operario: ${S.user.name} | Rol: ${S.user.role} | Área: ${S.user.area}
Fecha/hora: ${new Date().toLocaleString('es-AR')}
Turnos hoy: ${chHoy.length} | Total registros: ${S.checks.length}
OTs pendientes: ${otsPend.length} | En proceso: ${otsProc.length} | Total: ${S.ots.length}
Paradas totales: ${S.paradas.length} | Horas acumuladas: ${parasHrs.toFixed(1)}h
${otsPend.length > 0 ? 'OTs PENDIENTES: ' + otsPend.map(o=>`${o.titulo} [${o.prioridad}]`).join(', ') : ''}
${parasRec.length > 0 ? 'ÚLTIMAS PARADAS: ' + parasRec.map(p=>`${p.equipo}/${p.tipo}/${p.duracion}h`).join(', ') : ''}
${nosRecientes.length > 0 ? 'ÍTEMS EN NO (últimos turnos): ' + nosRecientes.slice(0,8).join('; ') : 'Sin ítems en NO recientes'}
Aprendizajes almacenados: ${(JSON.parse(localStorage.getItem('aria_know')||'[]')).length}`;
}

function ariaLearnFromContext() {
  // ARIA aprende automáticamente de patrones detectados
  const knows = JSON.parse(localStorage.getItem('aria_know') || '[]');
  
  // Detectar equipos con fallas repetitivas
  const fallas = {};
  S.paradas.forEach(p => { fallas[p.equipo] = (fallas[p.equipo]||0) + 1; });
  Object.entries(fallas).forEach(([eq, cnt]) => {
    if (cnt >= 2) {
      const key = `falla_${eq}`;
      if (!knows.find(k => k.id === key)) {
        knows.push({ id: key, cat: 'Falla Repetitiva', titulo: `${eq} — ${cnt} paradas`, desc: `Equipo con ${cnt} paradas registradas. Analizar causa raíz.`, fecha: new Date().toLocaleDateString('es-AR') });
      }
    }
  });

  // Detectar ítems de checklist frecuentemente en NO
  const nosCount = {};
  S.checks.forEach(c => {
    CL.filter(i => i.t === 'si_no').forEach(item => {
      if (c.valores && c.valores[item.id] === 'NO') nosCount[item.id] = (nosCount[item.id]||0) + 1;
    });
  });
  Object.entries(nosCount).forEach(([id, cnt]) => {
    if (cnt >= 2) {
      const item = CL.find(i => i.id === id);
      if (item) {
        const key = `checklist_no_${id}`;
        if (!knows.find(k => k.id === key)) {
          knows.push({ id: key, cat: 'Punto Crítico Checklist', titulo: item.l.substring(0,50), desc: `Marcado en NO ${cnt} veces. Requiere atención sistemática.`, fecha: new Date().toLocaleDateString('es-AR') });
        }
      }
    }
  });

  localStorage.setItem('aria_know', JSON.stringify(knows.slice(-50)));
  return knows;
}

function updateLearnBadge() {
  const knows = JSON.parse(localStorage.getItem('aria_know') || '[]');
  const lbl = document.getElementById('bot-learn-lbl');
  if (lbl) lbl.innerHTML = `&#128218; ${knows.length} aprendizajes`;
}

function renderKnowPanel() {
  const knows = ariaLearnFromContext();
  const list = document.getElementById('know-list');
  if (!list) return;
  if (knows.length === 0) {
    list.innerHTML = '<div style="color:var(--text-3);font-size:12px;text-align:center;padding:20px">ARIA aprende automáticamente<br>con cada turno y OT registrado.<br><br><em>Cargá datos para ver aprendizajes.</em></div>';
    return;
  }
  const cats = [...new Set(knows.map(k => k.cat))];
  list.innerHTML = cats.map(cat => `
    <div class="know-cat">
      <div class="know-cat-t">${cat}</div>
      ${knows.filter(k=>k.cat===cat).map(k=>`
        <div class="know-item" onclick="quickAsk('Contame más sobre: ${k.titulo}')">
          <div class="know-item-t">${k.titulo}</div>
          <div class="know-item-s">${k.desc}</div>
          <div style="font-size:10px;color:var(--text-3);margin-top:3px;font-family:var(--font-m)">${k.fecha}</div>
        </div>`).join('')}
    </div>`).join('');
}

function switchBotTab(tab, btn) {
  document.querySelectorAll('.bot-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('bot-msgs').style.display = 'none';
  document.getElementById('bot-panel-know').style.display = 'none';
  document.getElementById('bot-panel-tech').style.display = 'none';
  document.getElementById('bot-quick-row').style.display = tab === 'chat' ? 'flex' : 'none';
  if (tab === 'chat') {
    document.getElementById('bot-msgs').style.display = 'flex';
  } else if (tab === 'know') {
    renderKnowPanel();
    document.getElementById('bot-panel-know').style.display = 'block';
  } else if (tab === 'tech') {
    document.getElementById('bot-panel-tech').style.display = 'block';
  }
}

function toggleBot() {
  const chat = document.getElementById('bot-chat');
  chat.classList.toggle('open');
  if (chat.classList.contains('open')) {
    updateLearnBadge();
    setTimeout(() => document.getElementById('bot-input')?.focus(), 200);
  }
}

function botAdd(text, from, typing=false) {
  const m = document.getElementById('bot-msgs');
  if (typing) {
    const t = document.createElement('div');
    t.id = 'bot-typing';
    t.className = 'bot-typing';
    t.innerHTML = '<span></span><span></span><span></span>';
    m.appendChild(t);
    m.scrollTop = m.scrollHeight;
    return;
  }
  const old = document.getElementById('bot-typing');
  if (old) old.remove();
  const d = document.createElement('div');
  d.className = `bot-msg from-${from}`;
  d.innerHTML = text;
  m.appendChild(d);
  m.scrollTop = m.scrollHeight;
}

function botClearHistory() {
  ARIA_CONV.length = 0;
  document.getElementById('bot-msgs').innerHTML = '';
  botAdd(`<strong>Chat limpiado.</strong><br>Seguimos con la memoria de aprendizaje intacta. ¿En qué te ayudo?`, 'bot');
}

function quickAsk(msg) {
  document.getElementById('bot-input').value = msg;
  sendBot();
  // Switch to chat tab
  document.querySelectorAll('.bot-tab').forEach((b,i) => { if(i===0){b.classList.add('active')}else{b.classList.remove('active')}});
  document.getElementById('bot-msgs').style.display = 'flex';
  document.getElementById('bot-panel-know').style.display = 'none';
  document.getElementById('bot-panel-tech').style.display = 'none';
  document.getElementById('bot-quick-row').style.display = 'flex';
}

function askTech(topic) {
  quickAsk(`Explicame el procedimiento técnico para: ${topic}`);
}

async function sendBot() {
  const inp = document.getElementById('bot-input');
  const btn = document.getElementById('bot-send-btn');
  const msg = inp.value.trim();
  if (!msg || btn.disabled) return;

  // Show chat tab
  document.querySelectorAll('.bot-tab')[0].click();

  botAdd(msg, 'user');
  inp.value = '';
  inp.style.height = 'auto';
  btn.disabled = true;

  // Add to conversation history
  ARIA_CONV.push({ role: 'user', content: msg });
  if (ARIA_CONV.length > 20) ARIA_CONV.splice(0, 2); // keep last 10 turns

  // Show typing indicator
  botAdd('', 'bot', true);

  try {
    const systemPrompt = ARIA_SYSTEM + buildAriaContext();

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: systemPrompt,
        messages: ARIA_CONV.map(m => ({ role: m.role, content: m.content }))
      })
    });

    const data = await response.json();
    const reply = data.content?.[0]?.text || 'Sin respuesta del servidor.';

    // Add to history
    ARIA_CONV.push({ role: 'assistant', content: reply });

    // Format reply: convert markdown-ish to HTML
    const formatted = reply
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/`(.*?)`/g, '<code>$1</code>')
      .replace(/^• (.*)/gm, '• $1')
      .replace(/\n\n/g, '<br><br>')
      .replace(/\n/g, '<br>');

        // Auto-learn: extract key info from interaction
    ariaAutoLearn(msg, reply);

    botAdd(formatted, 'bot');
    updateLearnBadge();

    // Navigation commands
    const navMap = { dashboard: 'dashboard', turno: 'turno', historial: 'historial', ots: 'ots', paradas: 'paradas', energía: 'energia', energia: 'energia', proceso: 'proceso', reportes: 'reportes', personal: 'personal' };
    if (msg.toLowerCase().includes('ir a') || msg.toLowerCase().includes('navegá') || msg.toLowerCase().includes('abrir')) {
      Object.keys(navMap).forEach(k => { if (msg.toLowerCase().includes(k)) navigate(navMap[k]); });
    }

  } catch (err) {
    botAdd(`<span style="color:var(--amber)">⚠️ Error de conexión con la IA.</span><br><small style="color:var(--text-3)">${err.message}</small><br><br>Podés igualmente preguntarme datos del sistema.`, 'bot');
  } finally {
    btn.disabled = false;
    setTimeout(() => inp.focus(), 100);
  }
}

function ariaAutoLearn(question, answer) {
  // ARIA aprende de cada interacción: guarda temas consultados frecuentemente
  const knows = JSON.parse(localStorage.getItem('aria_know') || '[]');
  const freq = JSON.parse(localStorage.getItem('aria_freq') || '{}');
  
  // Registrar frecuencia de temas
  const words = question.toLowerCase().split(/\s+/).filter(w => w.length > 4);
  words.forEach(w => { freq[w] = (freq[w]||0) + 1; });
  localStorage.setItem('aria_freq', JSON.stringify(freq));

  // Si se consultó algo técnico, guardarlo como aprendizaje
  const techKeywords = ['falla','alarma','temperatura','presión','vibración','rodamiento','correa','bomba','caldera','compresor','motor','sello','aceite','filtro','válvula','loto','procedimiento','diagn'];
  const isTech = techKeywords.some(k => question.toLowerCase().includes(k));
  
  if (isTech) {
    const titulo = question.length > 55 ? question.substring(0, 55) + '...' : question;
    const key = 'qa_' + Date.now();
    // Evitar duplicados similares
    if (!knows.find(k => k.titulo.toLowerCase().includes(question.substring(0,20).toLowerCase()))) {
      knows.push({
        id: key,
        cat: 'Consulta Técnica',
        titulo,
        desc: answer.replace(/<[^>]+>/g, '').substring(0, 100) + '...',
        fecha: new Date().toLocaleDateString('es-AR')
      });
      localStorage.setItem('aria_know', JSON.stringify(knows.slice(-50)));
    }
  }
}

// ── CLOSE ON CLICK OUTSIDE ───────────────────────────────
document.addEventListener('click',e=>{
  if(!e.target.closest('[onclick*="toggleNotif"]')&&!e.target.closest('#notif-panel')) document.getElementById('notif-panel')?.classList.remove('open');
  if(!e.target.closest('[onclick*="toggleUM"]')&&!e.target.closest('#user-menu')) document.getElementById('user-menu')?.classList.remove('open');
});
document.addEventListener('keydown',e=>{
  if(e.key==='Escape') closeModal();
  if((e.ctrlKey||e.metaKey)&&e.key==='b'){e.preventDefault();toggleBot();}
});

// ── SESSION RESTORE ───────────────────────────────────────
window.addEventListener('DOMContentLoaded',()=>{
  const sess=localStorage.getItem('rpm5_sess');
  if(sess){ try{ const u=JSON.parse(sess); if(USERS[u.username]){S.user=u;bootApp();} }catch(e){} }
  document.getElementById('login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
});
</script>
</body>
</html>
